<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tax Calculator - Nigeria Tax Act 2025</title>
    
    <!-- EmailJS Library -->
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }

        .container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            padding: 40px;
            max-width: 650px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        h1 {
            color: #2d3748;
            font-size: 32px;
            margin-bottom: 10px;
            text-align: center;
        }

        .subtitle {
            color: #718096;
            text-align: center;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            color: #4a5568;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .label-info {
            color: #718096;
            font-weight: 400;
            font-size: 12px;
            margin-top: 2px;
        }

        input, select {
            width: 100%;
            padding: 14px 16px;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s ease;
            background: white;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        input::placeholder {
            color: #cbd5e0;
        }

        .calculate-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .calculate-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
        }

        .calculate-btn:active:not(:disabled) {
            transform: translateY(0);
        }

        .calculate-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .input-group {
            position: relative;
        }

        .currency-symbol {
            position: absolute;
            left: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: #718096;
            font-weight: 600;
        }

        input.with-symbol {
            padding-left: 35px;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 400px;
            width: 90%;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .modal-content h2 {
            color: #2d3748;
            margin-bottom: 20px;
            text-align: center;
        }

        .modal-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .modal-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .modal-btn.primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .modal-btn.secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .modal-btn:hover {
            transform: translateY(-2px);
        }

        .success-message {
            display: none;
            text-align: center;
            padding: 20px;
            background: #d4edda;
            border: 2px solid #28a745;
            border-radius: 10px;
            color: #155724;
            margin-top: 20px;
        }

        .success-message.active {
            display: block;
        }

        .section-header {
            background: #f7fafc;
            padding: 12px;
            border-radius: 8px;
            margin: 25px 0 15px 0;
            border-left: 4px solid #667eea;
        }

        .section-header h3 {
            color: #2d3748;
            font-size: 16px;
            font-weight: 600;
        }

        .tax-info {
            background: #edf2f7;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 13px;
            color: #4a5568;
        }

        .hidden {
            display: none;
        }

        select {
            cursor: pointer;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        .checkbox-group label {
            margin-bottom: 0;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üíº Tax Calculator</h1>
        <p class="subtitle">Nigeria Tax Calculator | Free Manual Entry or AI-Powered Bank Analysis</p>
        
        <!-- LANDING PAGE CTAs -->
        <div id="landingPage">
            <div class="tax-info" style="text-align: center; padding: 25px;">
                <h2 style="color: #2d3748; margin-bottom: 15px;">Choose Your Plan</h2>
                <p style="color: #718096; font-size: 15px;">Select the option that works best for you</p>
            </div>

            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-bottom: 30px;">
                
                <!-- Plan 1: Free -->
                <div style="background: white; border: 3px solid #e2e8f0; padding: 25px; border-radius: 15px; position: relative;">
                    <div style="background: #e2e8f0; color: #4a5568; padding: 8px 16px; border-radius: 20px; display: inline-block; font-size: 12px; font-weight: bold; margin-bottom: 15px;">
                        FREE
                    </div>
                    <h3 style="margin-bottom: 10px; font-size: 20px; color: #2d3748;">Manual Entry</h3>
                    <div style="font-size: 32px; font-weight: bold; color: #2d3748; margin: 15px 0;">‚Ç¶0</div>
                    <p style="color: #718096; font-size: 13px; margin-bottom: 20px;">Perfect for simple calculations</p>
                    
                    <div style="margin: 20px 0;">
                        <div style="font-size: 13px; margin: 8px 0; color: #4a5568;">‚úì Enter figures manually</div>
                        <div style="font-size: 13px; margin: 8px 0; color: #4a5568;">‚úì Full tax calculation</div>
                        <div style="font-size: 13px; margin: 8px 0; color: #4a5568;">‚úì Old & new tax laws</div>
                        <div style="font-size: 13px; margin: 8px 0; color: #4a5568;">‚úì Form A/CIT output</div>
                        <div style="font-size: 13px; margin: 8px 0; color: #4a5568;">‚úì Email results</div>
                        <div style="font-size: 13px; margin: 8px 0; color: #cbd5e0;">‚úó Bank statement upload</div>
                        <div style="font-size: 13px; margin: 8px 0; color: #cbd5e0;">‚úó AI categorization</div>
                    </div>
                    
                    <button onclick="selectFreePlan()" style="background: #667eea; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: bold; font-size: 14px; cursor: pointer; width: 100%; margin-top: 15px;">
                        Get Started Free
                    </button>
                </div>

                <!-- Plan 2: Basic (Pay-per-upload) -->
                <div style="background: white; border: 3px solid #ff9800; padding: 25px; border-radius: 15px; position: relative; transform: scale(1.05); box-shadow: 0 8px 24px rgba(255, 152, 0, 0.2);">
                    <div style="background: #ff9800; color: white; padding: 8px 16px; border-radius: 20px; display: inline-block; font-size: 12px; font-weight: bold; margin-bottom: 15px;">
                        RECOMMENDED
                    </div>
                    <h3 style="margin-bottom: 10px; font-size: 20px; color: #2d3748;">Basic Plan</h3>
                    <div style="font-size: 32px; font-weight: bold; color: #ff9800; margin: 15px 0;">‚Ç¶500</div>
                    <p style="color: #718096; font-size: 13px; margin-bottom: 20px;">Pay per upload (one-time)</p>
                    
                    <div style="margin: 20px 0;">
                        <div style="font-size: 13px; margin: 8px 0; color: #4a5568;">‚úì Everything in Free plan</div>
                        <div style="font-size: 13px; margin: 8px 0; color: #4a5568;">‚úì <strong>ONE bank statement upload</strong></div>
                        <div style="font-size: 13px; margin: 8px 0; color: #4a5568;">‚úì AI auto-categorization</div>
                        <div style="font-size: 13px; margin: 8px 0; color: #4a5568;">‚úì Tax optimization tips</div>
                        <div style="font-size: 13px; margin: 8px 0; color: #4a5568;">‚úì Duplicate detection</div>
                        <div style="font-size: 13px; margin: 8px 0; color: #cbd5e0;">‚úó Multi-bank compilation</div>
                        <div style="font-size: 13px; margin: 8px 0; color: #cbd5e0;">‚úó Unlimited uploads</div>
                    </div>
                    
                    <button onclick="selectBasicPlan()" style="background: #ff9800; color: white; border: none; padding: 12px 24px; border-radius: 25px; font-weight: bold; font-size: 14px; cursor: pointer; width: 100%; margin-top: 15px;">
                        Pay ‚Ç¶500 Per Upload
                    </button>
                    <div style="text-align: center; margin-top: 10px; font-size: 11px; color: #718096;">
                        Try once, upgrade anytime
                    </div>
                </div>

                <!-- Plan 3: Pro (Unlimited) -->
                <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; color: white; position: relative;">
                    <div style="background: rgba(255,255,255,0.3); color: white; padding: 8px 16px; border-radius: 20px; display: inline-block; font-size: 12px; font-weight: bold; margin-bottom: 15px;">
                        BEST VALUE
                    </div>
                    <h3 style="margin-bottom: 10px; font-size: 20px;">Pro Plan</h3>
                    <div style="font-size: 32px; font-weight: bold; margin: 15px 0;">‚Ç¶3,000</div>
                    <p style="opacity: 0.9; font-size: 13px; margin-bottom: 20px;">Full year unlimited access</p>
                    
                    <div style="margin: 20px 0;">
                        <div style="font-size: 13px; margin: 8px 0;">‚úì Everything in Basic plan</div>
                        <div style="font-size: 13px; margin: 8px 0;">‚úì <strong>UNLIMITED uploads</strong></div>
                        <div style="font-size: 13px; margin: 8px 0;">‚úì Multi-bank compilation</div>
                        <div style="font-size: 13px; margin: 8px 0;">‚úì Advanced optimization</div>
                        <div style="font-size: 13px; margin: 8px 0;">‚úì Inter-bank transfers</div>
                        <div style="font-size: 13px; margin: 8px 0;">‚úì Priority support</div>
                        <div style="font-size: 13px; margin: 8px 0;">‚úì Valid entire tax year</div>
                    </div>
                    
                    <button onclick="selectProPlan()" style="background: white; color: #667eea; border: none; padding: 12px 24px; border-radius: 25px; font-weight: bold; font-size: 14px; cursor: pointer; width: 100%; margin-top: 15px;">
                        Get Pro (Best Deal)
                    </button>
                    <div style="text-align: center; margin-top: 10px; font-size: 11px; opacity: 0.9;">
                        Save 83% vs 6 Basic uploads
                    </div>
                </div>
            </div>

            <div style="text-align: center; padding: 20px; background: #f7fafc; border-radius: 10px;">
                <p style="margin: 0; color: #4a5568; font-size: 14px;">
                    <strong>üí° Not sure?</strong> Start with the <strong>Free plan</strong> to try it out, or pay <strong>‚Ç¶500 once</strong> to test AI-powered analysis. Upgrade to <strong>Pro</strong> anytime for unlimited uploads!
                </p>
            </div>
        </div>

        <!-- PAYMENT MODAL -->
        <div class="modal" id="paymentModal">
            <div class="modal-content" style="max-width: 500px;">
                <h2 style="text-align: center; margin-bottom: 20px;" id="paymentModalTitle">üí≥ Complete Your Payment</h2>
                
                <div style="background: #e3f2fd; padding: 20px; border-radius: 10px; margin-bottom: 20px;" id="paymentSummary">
                    <!-- Dynamic content will be inserted here -->
                </div>

                <div class="form-group">
                    <label for="paymentEmail"><strong>Email Address</strong></label>
                    <input type="email" id="paymentEmail" placeholder="your.email@example.com" required>
                </div>

                <div class="form-group">
                    <label for="paymentName"><strong>Full Name</strong></label>
                    <input type="text" id="paymentName" placeholder="John Doe" required>
                </div>

                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-bottom: 20px; border-left: 4px solid #ff9800;">
                    <p style="margin: 0; font-size: 13px; color: #e65100;">
                        <strong>üîí Secure Payment:</strong> You'll be redirected to Paystack to complete your payment securely. We don't store your card details.
                    </p>
                </div>

                <button class="modal-btn primary" id="proceedToPayment" style="width: 100%; padding: 15px; font-size: 16px; margin-bottom: 10px;">
                    <!-- Dynamic text -->
                </button>
                
                <button class="modal-btn secondary" id="cancelPayment" style="width: 100%; padding: 12px;">
                    Cancel
                </button>
            </div>
        </div>

        <!-- TAX YEAR SELECTION (shown after payment or for manual) -->
        <div id="taxYearSelection" class="hidden">
        <div class="form-group">
            <label for="taxYear" style="font-size: 16px; color: #2d3748;">
                <strong>Select Tax Year / Law</strong>
            </label>
            <select id="taxYear" required style="font-size: 15px; font-weight: 600;">
                <option value="">-- Select Tax Year --</option>
                <option value="2026">2026 (New Tax Act 2025 - Effective Jan 2026)</option>
                <option value="2025">2025 or Earlier (Old PITA Law)</option>
            </select>
        </div>

        <div class="form-group" id="calculationModeGroup" style="display: none;">
            <label for="calculationMode" style="font-size: 16px; color: #2d3748;">
                <strong>Calculation Mode</strong>
            </label>
            <select id="calculationMode" required style="font-size: 15px; font-weight: 600;">
                <option value="">-- Select Mode --</option>
                <option value="manual">Manual Entry (Enter figures yourself)</option>
                <option value="bankstatement" id="bankStatementOption">ü§ñ Smart AI - Upload Bank Statement (Paid)</option>
            </select>
        </div>

        <div class="tax-info" id="taxYearInfo" style="display: none;"></div>
        
        <!-- BANK STATEMENT UPLOAD SECTION -->
        <div id="bankStatementSection" class="hidden">
            <div class="section-header" style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-left: none;">
                <h3>ü§ñ AI-Powered Bank Statement Analyzer</h3>
            </div>

            <div class="tax-info" style="background: #e3f2fd; border-left: 4px solid #2196f3;">
                <strong>How it works:</strong><br>
                1. Upload your bank statement (PDF, Excel, or CSV)<br>
                2. AI reads and categorizes all transactions<br>
                3. Automatically calculates taxable income<br>
                4. Flags unclear items for your review<br>
                5. Generates tax return ready for filing
            </div>

            <div class="form-group">
                <label for="bankStatementFile">
                    <strong>Upload Bank Statement(s)</strong>
                    <span class="label-info">(PDF, Excel, or CSV format | Max 10MB per file | Multiple files allowed)</span>
                </label>
                <input type="file" id="bankStatementFile" accept=".pdf,.xlsx,.xls,.csv" multiple
                       style="padding: 10px; border: 2px dashed #667eea;">
                <div id="filesList" style="margin-top: 10px; font-size: 13px; color: #666;"></div>
            </div>

            <div class="form-group">
                <label for="taxpayerEmail">
                    <strong>Your Email Address</strong>
                    <span class="label-info">(Used to identify and merge your previous calculations)</span>
                </label>
                <input type="email" id="taxpayerEmail" placeholder="your.email@example.com" required>
                <div id="previousCalculations" style="margin-top: 10px;"></div>
            </div>

            <div class="form-group">
                <label for="taxpayerName">
                    <strong>Full Name (as on bank statements)</strong>
                    <span class="label-info">(Helps match transactions across banks)</span>
                </label>
                <input type="text" id="taxpayerName" placeholder="John Doe">
            </div>

            <div class="form-group">
                <label for="statementYear">Statement Period</label>
                <select id="statementYear">
                    <option value="auto">ü§ñ Auto-Detect from Transaction Dates (Recommended)</option>
                    <option value="">-- Or Select Manually --</option>
                    <option value="2026">January - December 2026</option>
                    <option value="2025">January - December 2025</option>
                    <option value="2024">January - December 2024</option>
                    <option value="2023">January - December 2023</option>
                    <option value="custom">Custom Date Range</option>
                </select>
                <div id="autoDetectInfo" style="margin-top: 8px; padding: 10px; background: #e3f2fd; border-radius: 6px; font-size: 12px; display: none;">
                    <strong>ü§ñ Auto-Detection Active:</strong> System will analyze all transaction dates to determine the financial year and automatically apply the correct tax law (Old PITA or New NTA 2025).
                </div>
            </div>

            <div class="form-group hidden" id="customDateRange">
                <label>Custom Date Range</label>
                <div style="display: flex; gap: 10px;">
                    <input type="date" id="startDate" style="flex: 1;" placeholder="Start Date">
                    <input type="date" id="endDate" style="flex: 1;" placeholder="End Date">
                </div>
            </div>

            <div class="form-group">
                <label for="accountType">Account Type</label>
                <select id="accountType">
                    <option value="personal">Personal Account</option>
                    <option value="business">Business Account</option>
                    <option value="mixed">Mixed (Personal & Business)</option>
                </select>
            </div>

            <button type="button" class="calculate-btn" id="analyzeBankStatement" style="background: linear-gradient(135deg, #2196f3 0%, #1976d2 100%);">
                ü§ñ Analyze Bank Statement with AI
            </button>

            <!-- Analysis Results Section -->
            <div id="analysisResults" class="hidden" style="margin-top: 30px;">
                <div class="section-header" style="background: #4caf50; color: white; border-left: none;">
                    <h3>‚úÖ Analysis Complete!</h3>
                </div>

                <div class="results-card" style="border-left: 5px solid #4caf50;">
                    <h3>üìä Transaction Summary</h3>
                    <div id="transactionSummary"></div>
                </div>

                <div class="results-card" style="border-left: 5px solid #ff9800; margin-top: 20px;">
                    <h3>‚ö†Ô∏è Items Requiring Your Attention</h3>
                    <div id="urgentAttention"></div>
                </div>

                <div class="results-card" style="border-left: 5px solid #2196f3; margin-top: 20px;">
                    <h3>üí∞ Tax Calculation</h3>
                    <div id="taxCalculation"></div>
                </div>

                <div class="results-card" style="border-left: 5px solid #9c27b0; margin-top: 20px;">
                    <h3>üí° Smart Tax Optimization Suggestions</h3>
                    <div id="optimizationSuggestions"></div>
                </div>

                <button type="button" class="calculate-btn" id="proceedToFiling" style="margin-top: 20px;">
                    Continue to Tax Return Filing
                </button>
            </div>
        
        <div id="calculatorContent" class="hidden">
        <div class="tax-info">
            <strong>Employee/PAYE:</strong> Tax deducted monthly by employer | Progressive rates 0%-25%<br>
            <strong>Self-Employed/Freelancer:</strong> Same tax rates | Annual self-assessment filing required<br>
            <strong>Company Tax:</strong> Small companies (‚â§‚Ç¶100M turnover) pay 0% | Large companies 30%
        </div>

        <form id="taxForm">
            <div class="form-group">
                <label for="taxType">Tax Type</label>
                <select id="taxType" required>
                    <option value="">-- Select Tax Type --</option>
                    <option value="employee">Employee Tax (PAYE Method - Monthly Withholding)</option>
                    <option value="selfemployed">Self-Employed/Freelancer Tax (Annual Filing)</option>
                    <option value="company">Company Tax (CIT)</option>
                </select>
            </div>

            <!-- EMPLOYEE TAX SECTION -->
            <div id="employeeSection" class="hidden">
                <div class="tax-info" style="background: #e8f5e9; border-left: 4px solid #4caf50;">
                    <strong>PAYE Method:</strong> Your employer calculates and deducts tax monthly from your salary. Same tax rates as self-employed, but automatically withheld.
                </div>

                <div class="form-group">
                    <label for="staffName">Staff/Employee Name</label>
                    <input type="text" id="staffName" placeholder="Enter name">
                </div>

                <div class="section-header">
                    <h3>üìä Income Details</h3>
                </div>

                <div class="form-group">
                    <label for="salary">Annual Gross Salary</label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="salary" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="section-header">
                    <h3>üè† Housing & Accommodation</h3>
                </div>

                <div class="form-group">
                    <label for="rent">
                        Annual Rent Paid
                        <span class="label-info">(Rent Relief: 20% up to ‚Ç¶500,000 max)</span>
                    </label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="rent" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="housingLoan">
                        Interest on Housing Loan
                        <span class="label-info">(For owner-occupied home - fully deductible)</span>
                    </label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="housingLoan" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="section-header">
                    <h3>üí∞ Statutory Deductions</h3>
                </div>

                <div class="form-group">
                    <label for="pension">
                        Pension Contribution (Employee)
                        <span class="label-info">(8% of Basic + Housing + Transport)</span>
                    </label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="pension" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="nhf">
                        NHF Contribution
                        <span class="label-info">(National Housing Fund - 2.5% of basic salary)</span>
                    </label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="nhf" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="nhis">
                        NHIS Contribution
                        <span class="label-info">(National Health Insurance - typically 5% of basic)</span>
                    </label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="nhis" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="health">Health Insurance Premium (HMO/Private)</label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="health" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="section-header">
                    <h3>üìã Additional Deductions</h3>
                </div>

                <div class="form-group">
                    <label for="lifeInsurance">
                        Life Insurance Premium
                        <span class="label-info">(For you and spouse - fully deductible)</span>
                    </label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="lifeInsurance" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="otherDeductibles">Other Allowable Deductibles</label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="otherDeductibles" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>
            </div>

            <!-- SELF-EMPLOYED TAX SECTION -->
            <div id="selfEmployedSection" class="hidden">
                <div class="tax-info" style="background: #fff3e0; border-left: 4px solid #ff9800;">
                    <strong>Self-Assessment Method:</strong> You must file annual tax returns (Form A) with your State IRS by March 31. Same tax rates as employees, but you calculate and pay directly.
                </div>

                <div class="form-group">
                    <label for="selfEmployedName">Your Name / Business Name</label>
                    <input type="text" id="selfEmployedName" placeholder="Enter your name or business name">
                </div>

                <div class="section-header">
                    <h3>üíº Business Information</h3>
                </div>

                <div class="form-group">
                    <label for="businessType">Type of Business/Service</label>
                    <select id="businessType">
                        <option value="">-- Select Type --</option>
                        <option value="freelancer">Freelancer (Consultant, Writer, Designer, etc.)</option>
                        <option value="trader">Trader (Retail, Wholesale)</option>
                        <option value="artisan">Artisan (Tailor, Barber, Mechanic, etc.)</option>
                        <option value="agent">Agent/Commission-Based (POS, Real Estate, Insurance)</option>
                        <option value="professional">Professional Services (Law, Accounting, etc.)</option>
                        <option value="other">Other</option>
                    </select>
                </div>

                <div class="section-header">
                    <h3>üìä Income Details (Annual)</h3>
                </div>

                <div class="form-group">
                    <label for="selfGrossIncome">
                        Total Gross Income
                        <span class="label-info">(All income received before expenses)</span>
                    </label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="selfGrossIncome" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="section-header">
                    <h3>üí∞ Business Expenses (Deductible)</h3>
                </div>

                <div class="form-group">
                    <label for="selfBusinessExpenses">
                        Total Business Expenses
                        <span class="label-info">(Rent, transport, materials, utilities, salaries, etc.)</span>
                    </label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="selfBusinessExpenses" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="section-header">
                    <h3>üè† Personal Reliefs & Deductions</h3>
                </div>

                <div class="form-group">
                    <label for="selfRent">
                        Annual Rent Paid (Personal Residence)
                        <span class="label-info">(Rent Relief: 20% up to ‚Ç¶500,000 max)</span>
                    </label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="selfRent" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="selfPension">
                        Voluntary Pension Contributions
                        <span class="label-info">(If you contribute to a pension fund)</span>
                    </label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="selfPension" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="selfNHF">NHF Contributions (Voluntary)</label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="selfNHF" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="selfNHIS">NHIS Contributions (Voluntary)</label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="selfNHIS" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="selfHealthInsurance">Health Insurance Premium</label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="selfHealthInsurance" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="selfLifeInsurance">Life Insurance Premium</label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="selfLifeInsurance" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="tax-info" style="background: #ffebee; border-left: 4px solid #f44336; margin-top: 20px;">
                    <strong>üìã Important Filing Requirements:</strong><br>
                    ‚Ä¢ Register for Tax Identification Number (TIN) if you don't have one<br>
                    ‚Ä¢ File Form A with your State Internal Revenue Service by March 31<br>
                    ‚Ä¢ Keep all receipts and records for at least 6 years<br>
                    ‚Ä¢ Pay calculated tax in full or arrange installment payment
                </div>
            </div>

            <!-- COMPANY TAX SECTION -->
            <div id="companySection" class="hidden">
                <div class="form-group">
                    <label for="companyName">Company Name</label>
                    <input type="text" id="companyName" placeholder="Enter company name">
                </div>

                <div class="section-header">
                    <h3>üíº Company Information</h3>
                </div>

                <div class="form-group">
                    <label for="grossTurnover">Annual Gross Turnover</label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="grossTurnover" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="totalAssets">Total Fixed Assets</label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="totalAssets" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="assessableProfit">Assessable Profit (Before Tax)</label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="assessableProfit" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="isProfessional">
                    <label for="isProfessional">Professional Services Company (Law, Accounting, Consulting, etc.)</label>
                </div>

                <div class="section-header">
                    <h3>üéÅ Tax Incentives & Reliefs</h3>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="hasEDI">
                    <label for="hasEDI">Eligible for Economic Development Incentive (EDI)</label>
                </div>

                <div class="form-group hidden" id="ediGroup">
                    <label for="ediCapex">
                        Qualifying Capital Expenditure
                        <span class="label-info">(5% annual tax credit for 5 years)</span>
                    </label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="ediCapex" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="isAgribusiness">
                    <label for="isAgribusiness">New Agribusiness Company (5-year tax holiday)</label>
                </div>

                <div class="checkbox-group">
                    <input type="checkbox" id="isFreeZone">
                    <label for="isFreeZone">Free Zone Enterprise</label>
                </div>

                <div class="form-group hidden" id="freeZoneGroup">
                    <label for="domesticSales">
                        Sales into Nigerian Customs Territory (%)
                        <span class="label-info">(If >25%, that portion is taxable)</span>
                    </label>
                    <input type="number" id="domesticSales" placeholder="0" min="0" max="100" step="0.01">
                </div>

                <div class="form-group">
                    <label for="capitalAllowance">Capital Allowances Claimed</label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="capitalAllowance" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>

                <div class="form-group">
                    <label for="lossCarryForward">Tax Loss Carried Forward (from previous years)</label>
                    <div class="input-group">
                        <span class="currency-symbol">‚Ç¶</span>
                        <input type="number" id="lossCarryForward" class="with-symbol" placeholder="0.00" step="0.01">
                    </div>
                </div>
            </div>

            <button type="submit" class="calculate-btn" id="calculateBtn">Calculate Tax</button>
        </form>

        <div class="success-message" id="successMessage">
            ‚úì Tax calculation completed and sent successfully!
        </div>

        <!-- Results Summary Card -->
        <div class="results-card hidden" id="resultsCard">
            <h3>üéâ Your Tax Calculation Results</h3>
            
            <div class="savings-highlight" id="savingsHighlight">
                <div style="font-size: 16px;">üí∞ Estimated Tax Savings Identified</div>
                <div class="amount" id="savingsAmount">‚Ç¶0</div>
                <div style="font-size: 14px;" id="savingsDescription">Through legal deductions and reliefs</div>
            </div>

            <div id="resultDetails"></div>

            <div class="referral-box">
                <h3>üéÅ Get More Free Calculations!</h3>
                <p style="margin: 10px 0; font-size: 14px;">Share with 3 friends and get 5 bonus calculations</p>
                <div class="referral-link" id="referralLink">Loading...</div>
                <p style="margin: 10px 0; font-size: 13px;" id="referralStats">Referrals: 0 | Bonus calculations: 0</p>
                
                <div class="share-buttons">
                    <button class="share-btn whatsapp" id="shareWhatsApp">
                        üì± Share on WhatsApp
                    </button>
                    <button class="share-btn twitter" id="shareTwitter">
                        üê¶ Share on Twitter
                    </button>
                    <button class="share-btn linkedin" id="shareLinkedIn">
                        üíº Share on LinkedIn
                    </button>
                    <button class="share-btn copy" id="copyLink">
                        üìã Copy Link
                    </button>
                </div>
            </div>
        </div>
        </div>
    </div>

    <div class="modal" id="emailModal">
        <div class="modal-content">
            <h2>Enter Your Email</h2>
            <p style="color: #718096; margin-bottom: 20px; text-align: center;">We'll send the tax calculation results to your email</p>
            
            <div class="usage-info" id="usageInfo" style="display: none;">
                üìä You have <strong><span id="remainingCalcs"></span></strong> free calculation(s) remaining
                <span id="bonusInfo" style="display: none;"><br>üéÅ Including <strong><span id="bonusCount"></span></strong> bonus from referrals!</span>
            </div>
            
            <div class="form-group">
                <label for="userEmail">Email Address</label>
                <input type="email" id="userEmail" placeholder="your.email@example.com" required>
            </div>
            
            <div class="limit-exceeded" id="limitExceeded" style="display: none;">
                <strong>‚ö†Ô∏è Free Calculation Limit Reached</strong>
                <p>You've used all 3 free calculations with this email address.</p>
                <p>For unlimited calculations and premium features, please sign up at:</p>
                <a href="https://leaveledge.com" target="_blank" style="font-size: 16px;">üëâ Leaveledge.com</a>
            </div>
            
            <div class="modal-buttons">
                <button class="modal-btn secondary" id="cancelBtn">Cancel</button>
                <button class="modal-btn primary" id="submitBtn">Submit</button>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // EMAILJS CONFIGURATION - REPLACE THESE VALUES
        // ============================================
        const EMAILJS_PUBLIC_KEY = "YOUR_PUBLIC_KEY_HERE";  // Replace with your EmailJS Public Key
        const EMAILJS_SERVICE_ID = "YOUR_SERVICE_ID_HERE";  // Replace with your EmailJS Service ID
        const EMAILJS_TEMPLATE_ID = "YOUR_TEMPLATE_ID_HERE"; // Replace with your EmailJS Template ID
        
        // Initialize EmailJS
        (function(){
            emailjs.init(EMAILJS_PUBLIC_KEY);
        })();
        
        // Usage tracking system
        const MAX_FREE_CALCULATIONS = 3;
        
        function getUsageData() {
            const data = localStorage.getItem('taxCalcUsage');
            return data ? JSON.parse(data) : {};
        }
        
        function saveUsageData(data) {
            localStorage.setItem('taxCalcUsage', JSON.stringify(data));
        }
        
        function getEmailUsageCount(email) {
            const usage = getUsageData();
            return usage[email.toLowerCase()] || 0;
        }
        
        function incrementEmailUsage(email) {
            const usage = getUsageData();
            const emailKey = email.toLowerCase();
            usage[emailKey] = (usage[emailKey] || 0) + 1;
            saveUsageData(usage);
            return usage[emailKey];
        }
        
        function checkUsageLimit(email) {
            const count = getEmailUsageCount(email);
            const bonusCalcs = getReferralBonus(email);
            const total = count - bonusCalcs;
            const remaining = Math.max(0, MAX_FREE_CALCULATIONS - total);
            
            return {
                allowed: remaining > 0,
                remaining: remaining,
                used: count,
                bonusCalcs: bonusCalcs
            };
        }
        
        // Referral system
        function generateReferralCode(email) {
            return btoa(email).substring(0, 10).replace(/[^a-zA-Z0-9]/g, '');
        }
        
        function getReferralData() {
            const data = localStorage.getItem('taxCalcReferrals');
            return data ? JSON.parse(data) : {};
        }
        
        function saveReferralData(data) {
            localStorage.setItem('taxCalcReferrals', JSON.stringify(data));
        }
        
        function trackReferral(referrerCode, newUserEmail) {
            const referrals = getReferralData();
            if (!referrals[referrerCode]) {
                referrals[referrerCode] = [];
            }
            if (!referrals[referrerCode].includes(newUserEmail.toLowerCase())) {
                referrals[referrerCode].push(newUserEmail.toLowerCase());
                saveReferralData(referrals);
                return true;
            }
            return false;
        }
        
        function getReferralCount(email) {
            const code = generateReferralCode(email);
            const referrals = getReferralData();
            return referrals[code] ? referrals[code].length : 0;
        }
        
        function getReferralBonus(email) {
            const count = getReferralCount(email);
            return Math.floor(count / 3) * 5; // 5 bonus calculations per 3 referrals
        }
        
        function getMyReferralLink(email) {
            const code = generateReferralCode(email);
            const baseUrl = window.location.origin + window.location.pathname;
            return `${baseUrl}?ref=${code}`;
        }
        
        // Check for referral code on page load
        window.addEventListener('load', function() {
            const urlParams = new URLSearchParams(window.location.search);
            const refCode = urlParams.get('ref');
            if (refCode) {
                sessionStorage.setItem('referralCode', refCode);
            }
        });
        
        let calculationData = {};
        let selectedTaxYear = null;
        let bankStatementData = null;
        let compiledBankData = [];
        let userTaxHistory = {};
        let userPlan = 'free'; // 'free', 'basic', 'pro'
        let basicPlanUploadsRemaining = 0;
        let selectedPaymentPlan = null;

        // Plan selection handlers
        function selectFreePlan() {
            userPlan = 'free';
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('taxYearSelection').classList.remove('hidden');
            document.getElementById('calculationModeGroup').style.display = 'none';
        }

        function selectBasicPlan() {
            selectedPaymentPlan = 'basic';
            showPaymentModal('basic');
        }

        function selectProPlan() {
            selectedPaymentPlan = 'pro';
            showPaymentModal('pro');
        }

        function showPaymentModal(plan) {
            const modal = document.getElementById('paymentModal');
            const summaryDiv = document.getElementById('paymentSummary');
            const btn = document.getElementById('proceedToPayment');
            
            if (plan === 'basic') {
                summaryDiv.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #ff9800;">‚Ç¶500</div>
                        <div style="font-size: 14px; color: #e65100; margin-top: 5px;">Pay per upload (one-time)</div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #bbdefb;">
                        <div style="font-size: 13px; color: #01579b; margin: 5px 0;">‚úì Upload ONE bank statement</div>
                        <div style="font-size: 13px; color: #01579b; margin: 5px 0;">‚úì AI auto-categorization</div>
                        <div style="font-size: 13px; color: #01579b; margin: 5px 0;">‚úì Tax optimization tips</div>
                        <div style="font-size: 13px; color: #01579b; margin: 5px 0;">‚úì Duplicate detection</div>
                        <div style="font-size: 13px; color: #01579b; margin: 5px 0;">‚úì Filing-ready returns</div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: #fff9c4; border-radius: 8px; font-size: 12px; color: #f57f17;">
                        üí° <strong>Tip:</strong> Need multiple uploads? Upgrade to Pro (‚Ç¶3,000) for unlimited access!
                    </div>
                `;
                btn.textContent = 'Pay ‚Ç¶500 - One Upload';
            } else if (plan === 'pro') {
                summaryDiv.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 32px; font-weight: bold; color: #667eea;">‚Ç¶3,000</div>
                        <div style="font-size: 14px; color: #5e35b1; margin-top: 5px;">Full year unlimited access</div>
                    </div>
                    <div style="margin-top: 15px; padding-top: 15px; border-top: 1px solid #bbdefb;">
                        <div style="font-size: 13px; color: #01579b; margin: 5px 0;">‚úì <strong>UNLIMITED</strong> bank statement uploads</div>
                        <div style="font-size: 13px; color: #01579b; margin: 5px 0;">‚úì Multi-bank compilation</div>
                        <div style="font-size: 13px; color: #01579b; margin: 5px 0;">‚úì Advanced AI categorization</div>
                        <div style="font-size: 13px; color: #01579b; margin: 5px 0;">‚úì Inter-bank transfer detection</div>
                        <div style="font-size: 13px; color: #01579b; margin: 5px 0;">‚úì Priority support</div>
                        <div style="font-size: 13px; color: #01579b; margin: 5px 0;">‚úì Valid for entire tax year</div>
                    </div>
                    <div style="margin-top: 15px; padding: 12px; background: #e8f5e9; border-radius: 8px; font-size: 12px; color: #2e7d32;">
                        üéâ <strong>Best Value:</strong> Save 83% compared to 6 Basic plan uploads!
                    </div>
                `;
                btn.textContent = 'Pay ‚Ç¶3,000 - Get Pro';
            }
            
            modal.classList.add('active');
        }

        // Landing page CTA handlers (kept for backward compatibility)
        function showPaymentOption() {
            selectProPlan();
        }

        function showManualCalculator() {
            selectFreePlan();
        }

        // Payment modal handlers
        document.getElementById('cancelPayment').addEventListener('click', function() {
            document.getElementById('paymentModal').classList.remove('active');
        });

        document.getElementById('proceedToPayment').addEventListener('click', async function() {
            const email = document.getElementById('paymentEmail').value.trim();
            const name = document.getElementById('paymentName').value.trim();

            if (!email || !email.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            if (!name) {
                alert('Please enter your full name');
                return;
            }

            const btn = this;
            btn.disabled = true;
            btn.textContent = 'Processing...';

            try {
                // Initialize Paystack payment
                await initiatePaystackPayment(email, name);
            } catch (error) {
                alert('Payment initialization failed. Please try again.');
                console.error('Payment error:', error);
                btn.disabled = false;
                btn.textContent = 'Proceed to Secure Payment (‚Ç¶2,500)';
            }
        });

        async function initiatePaystackPayment(email, name) {
            // Paystack configuration
            const PAYSTACK_PUBLIC_KEY = 'pk_test_REPLACE_WITH_YOUR_PAYSTACK_PUBLIC_KEY'; // Replace with your key
            const AMOUNT = 250000; // ‚Ç¶2,500 in kobo (Paystack uses kobo)

            // In production, load Paystack script dynamically
            if (!window.PaystackPop) {
                // Load Paystack inline script
                const script = document.createElement('script');
                script.src = 'https://js.paystack.co/v1/inline.js';
                document.head.appendChild(script);
                
                await new Promise((resolve) => {
                    script.onload = resolve;
                });
            }

            // Initialize Paystack payment
            const handler = PaystackPop.setup({
                key: PAYSTACK_PUBLIC_KEY,
                email: email,
                amount: AMOUNT,
                currency: 'NGN',
                ref: 'TAX_AI_' + Math.floor(Math.random() * 1000000000) + '_' + Date.now(),
                metadata: {
                    custom_fields: [
                        {
                            display_name: "Customer Name",
                            variable_name: "customer_name",
                            value: name
                        },
                        {
                            display_name: "Service",
                            variable_name: "service",
                            value: "AI-Powered Tax Analysis"
                        }
                    ]
                },
                callback: function(response) {
                    // Payment successful
                    handleSuccessfulPayment(response.reference, email, name);
                },
                onClose: function() {
                    // User closed payment modal
                    document.getElementById('proceedToPayment').disabled = false;
                    document.getElementById('proceedToPayment').textContent = 'Proceed to Secure Payment (‚Ç¶2,500)';
                }
            });

            handler.openIframe();
        }

        function handleSuccessfulPayment(reference, email, name) {
            // Save payment record to localStorage
            const paymentRecord = {
                reference: reference,
                email: email,
                name: name,
                amount: 2500,
                date: new Date().toISOString(),
                taxYear: new Date().getFullYear(),
                status: 'paid'
            };

            const payments = localStorage.getItem('aiTaxPayments');
            const allPayments = payments ? JSON.parse(payments) : {};
            
            if (!allPayments[email.toLowerCase()]) {
                allPayments[email.toLowerCase()] = [];
            }
            
            allPayments[email.toLowerCase()].push(paymentRecord);
            localStorage.setItem('aiTaxPayments', JSON.stringify(allPayments));

            // Grant access
            hasAIPaidAccess = true;

            // Close payment modal
            document.getElementById('paymentModal').classList.remove('active');

            // Show success message
            alert(`‚úì Payment Successful!\n\nReference: ${reference}\n\nYou now have full access to AI-powered bank statement analysis. You can upload unlimited statements for this tax year.`);

            // Show calculator with AI option enabled
            document.getElementById('landingPage').style.display = 'none';
            document.getElementById('taxYearSelection').classList.remove('hidden');
            document.getElementById('calculationModeGroup').style.display = 'block';
            
            // Pre-fill email in bank statement section
            setTimeout(() => {
                document.getElementById('taxpayerEmail').value = email;
                document.getElementById('taxpayerName').value = name;
            }, 500);
        }

        function checkExistingPayment(email) {
            const payments = localStorage.getItem('aiTaxPayments');
            if (!payments) return false;

            const allPayments = JSON.parse(payments);
            const userPayments = allPayments[email.toLowerCase()];

            if (!userPayments || userPayments.length === 0) return false;

            // Check if user has paid for current tax year
            const currentYear = new Date().getFullYear();
            const validPayment = userPayments.find(p => 
                p.status === 'paid' && 
                p.taxYear === currentYear
            );

            return !!validPayment;
        }

        // File selection handler
        document.getElementById('bankStatementFile').addEventListener('change', function() {
            const files = this.files;
            const filesList = document.getElementById('filesList');
            
            if (files.length === 0) {
                filesList.innerHTML = '';
                return;
            }
            
            let html = `<strong>${files.length} file(s) selected:</strong><br>`;
            Array.from(files).forEach((file, index) => {
                html += `${index + 1}. ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)<br>`;
            });
            filesList.innerHTML = html;
        });

        // Check for previous calculations when email is entered
        document.getElementById('taxpayerEmail').addEventListener('blur', function() {
            const email = this.value.trim().toLowerCase();
            if (email && email.includes('@')) {
                checkPreviousCalculations(email);
            }
        });

        function checkPreviousCalculations(email) {
            // Get user's tax history from localStorage
            const taxHistory = localStorage.getItem('userTaxHistory');
            if (!taxHistory) {
                document.getElementById('previousCalculations').innerHTML = '';
                return;
            }

            const allHistory = JSON.parse(taxHistory);
            const userHistory = allHistory[email];
            
            if (userHistory && userHistory.length > 0) {
                userTaxHistory[email] = userHistory;
                const latestCalc = userHistory[userHistory.length - 1];
                const previousCount = userHistory.length;
                
                document.getElementById('previousCalculations').innerHTML = `
                    <div style="background: #e8f5e9; padding: 10px; border-radius: 6px; border-left: 3px solid #4caf50;">
                        <strong>‚úì Previous Data Found!</strong><br>
                        <span style="font-size: 12px;">
                            ${previousCount} previous calculation(s) for this email<br>
                            Last calculated: ${latestCalc.date}<br>
                            <span style="color: #2e7d32;">New bank data will be merged with previous records to avoid duplicates</span>
                        </span>
                    </div>
                `;
            } else {
                document.getElementById('previousCalculations').innerHTML = '';
            }
        }

        // Calculation mode selector
        document.getElementById('calculationMode').addEventListener('change', function() {
            const mode = this.value;
            const bankStatementSection = document.getElementById('bankStatementSection');
            const calculatorContent = document.getElementById('calculatorContent');
            
            if (mode === 'bankstatement') {
                // Check if user has paid
                if (!hasAIPaidAccess) {
                    alert('AI-Powered Bank Statement Analysis requires payment.\n\nPlease go back and select "Upload Bank Statement" to make payment.');
                    this.value = '';
                    return;
                }
                
                bankStatementSection.classList.remove('hidden');
                calculatorContent.classList.add('hidden');
            } else if (mode === 'manual') {
                bankStatementSection.classList.add('hidden');
                if (selectedTaxYear) {
                    calculatorContent.classList.remove('hidden');
                }
            } else {
                bankStatementSection.classList.add('hidden');
                calculatorContent.classList.add('hidden');
            }
        });

        // Custom date range toggle
        document.getElementById('statementYear').addEventListener('change', function() {
            const customDateRange = document.getElementById('customDateRange');
            const autoDetectInfo = document.getElementById('autoDetectInfo');
            
            if (this.value === 'custom') {
                customDateRange.classList.remove('hidden');
                autoDetectInfo.style.display = 'none';
            } else {
                customDateRange.classList.add('hidden');
                if (this.value === 'auto') {
                    autoDetectInfo.style.display = 'block';
                } else {
                    autoDetectInfo.style.display = 'none';
                }
            }
        });

        // Bank Statement Analysis
        document.getElementById('analyzeBankStatement').addEventListener('click', async function() {
            const fileInput = document.getElementById('bankStatementFile');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('Please upload a bank statement file first');
                return;
            }

            if (!selectedTaxYear) {
                alert('Please select a tax year first');
                return;
            }

            const accountType = document.getElementById('accountType').value;
            
            // Show loading state
            const btn = this;
            btn.disabled = true;
            btn.innerHTML = 'üîÑ Analyzing... Please wait';

            try {
                // Read the file
                const fileData = await readFileData(file);
                
                // Analyze with AI
                const analysis = await analyzeWithAI(fileData, file.type, accountType);
                
                // Store results
                bankStatementData = analysis;
                
                // Display results
                displayAnalysisResults(analysis);
                
                // Scroll to results
                document.getElementById('analysisResults').scrollIntoView({ behavior: 'smooth' });
                
            } catch (error) {
                alert('Error analyzing bank statement: ' + error.message);
                console.error('Analysis error:', error);
            } finally {
                btn.disabled = false;
                btn.innerHTML = 'ü§ñ Analyze Bank Statement with AI';
            }
        });

        async function readFileData(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                
                reader.onload = async (e) => {
                    try {
                        const data = e.target.result;
                        
                        if (file.type === 'application/pdf') {
                            // For PDF, send base64 data
                            const base64 = data.split(',')[1];
                            resolve({ type: 'pdf', data: base64 });
                        } else if (file.name.endsWith('.csv')) {
                            // For CSV, parse with PapaParse
                            const text = new TextDecoder().decode(new Uint8Array(data));
                            resolve({ type: 'csv', data: text });
                        } else if (file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                            // For Excel, send base64
                            const base64 = btoa(
                                new Uint8Array(data).reduce((data, byte) => data + String.fromCharCode(byte), '')
                            );
                            resolve({ type: 'excel', data: base64 });
                        } else {
                            reject(new Error('Unsupported file format'));
                        }
                    } catch (error) {
                        reject(error);
                    }
                };
                
                reader.onerror = () => reject(new Error('Failed to read file'));
                
                if (file.type === 'application/pdf' || file.name.endsWith('.xlsx') || file.name.endsWith('.xls')) {
                    reader.readAsDataURL(file);
                } else {
                    reader.readAsArrayBuffer(file);
                }
            });
        }

        async function analyzeWithAI(fileData, fileType, accountType, fileName) {
            // Prepare prompt for Claude
            const systemPrompt = `You are an expert Nigerian tax accountant and bank statement analyzer. Your job is to:

1. Extract ALL transactions from the bank statement
2. Identify the BANK NAME from the statement (GTBank, Access, Zenith, UBA, First Bank, etc.)
3. Categorize each transaction as:
   - INCOME: Salary, business revenue, commissions, consultancy fees, rental income, etc.
   - EXPENSE: Business expenses, rent paid, utilities, etc.
   - TRANSFER: Between own accounts (not taxable)
   - UNCLEAR: Transactions that need human review

4. For INCOME transactions, identify:
   - Employment income (salary, allowances)
   - Business/professional income
   - Rental income
   - Investment income
   - Other taxable income

5. For EXPENSE transactions, identify tax-deductible items:
   - Rent paid
   - Pension contributions
   - NHF contributions
   - NHIS/Health insurance
   - Business expenses (if business account)

6. Flag UNCLEAR items that require human attention

7. Calculate total taxable income

Respond ONLY with valid JSON in this exact format:
{
  "bankName": "string (GTBank|Access|Zenith|UBA|FirstBank|Other)",
  "accountNumber": "string (last 4 digits only for privacy)",
  "statementPeriod": {"start": "YYYY-MM-DD", "end": "YYYY-MM-DD"},
  "totalTransactions": number,
  "totalCredits": number,
  "totalDebits": number,
  "income": [
    {
      "date": "YYYY-MM-DD",
      "description": "string",
      "amount": number,
      "category": "Salary|Business Income|Rental|Other",
      "confidence": "high|medium|low",
      "transactionId": "unique_hash_of_date_amount_description"
    }
  ],
  "expenses": [
    {
      "date": "YYYY-MM-DD",
      "description": "string",
      "amount": number,
      "category": "Rent|Pension|Business Expense|Other",
      "deductible": true/false,
      "confidence": "high|medium|low",
      "transactionId": "unique_hash_of_date_amount_description"
    }
  ],
  "unclear": [
    {
      "date": "YYYY-MM-DD",
      "description": "string",
      "amount": number,
      "type": "credit|debit",
      "reason": "why this needs attention",
      "transactionId": "unique_hash_of_date_amount_description"
    }
  ],
  "summary": {
    "totalIncome": number,
    "salaryIncome": number,
    "businessIncome": number,
    "otherIncome": number,
    "deductibleExpenses": number,
    "rentPaid": number,
    "pensionContributions": number
  }
}

IMPORTANT: Generate a unique transactionId for each transaction by hashing the date+amount+description to help detect duplicates across bank accounts.`;

            const userPrompt = fileData.type === 'csv' 
                ? `Analyze this CSV bank statement (${fileName}):\n\n${fileData.data}\n\nAccount Type: ${accountType}`
                : `This is a ${fileData.type} bank statement file (${fileName}). Account Type: ${accountType}. Please analyze it.`;

            // Call Claude API (same as before)
            const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 4000,
                    system: systemPrompt,
                    messages: [
                        {
                            role: "user",
                            content: fileData.type === 'pdf' || fileData.type === 'excel'
                                ? [
                                    {
                                        type: "document",
                                        source: {
                                            type: "base64",
                                            media_type: fileData.type === 'pdf' ? "application/pdf" : "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                                            data: fileData.data
                                        }
                                    },
                                    {
                                        type: "text",
                                        text: userPrompt
                                    }
                                ]
                                : userPrompt
                        }
                    ]
                })
            });

            const result = await response.json();
            
            if (!result.content || !result.content[0]) {
                throw new Error('Invalid API response');
            }

            // Extract JSON from response
            let jsonText = result.content[0].text;
            jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            
            const parsed = JSON.parse(jsonText);
            parsed.fileName = fileName;
            
            return parsed;
        }

        function mergeBankStatements(analysisResults, taxpayerEmail, taxpayerName) {
            // Create a comprehensive merged dataset
            const merged = {
                taxpayerEmail: taxpayerEmail,
                taxpayerName: taxpayerName,
                numberOfBanks: analysisResults.length,
                banks: [],
                totalTransactions: 0,
                totalCredits: 0,
                totalDebits: 0,
                income: [],
                expenses: [],
                unclear: [],
                duplicates: [],
                summary: {
                    totalIncome: 0,
                    salaryIncome: 0,
                    businessIncome: 0,
                    otherIncome: 0,
                    deductibleExpenses: 0,
                    rentPaid: 0,
                    pensionContributions: 0
                }
            };

            // Track unique transactions by ID
            const seenTransactionIds = new Set();
            const duplicateTransactions = [];

            // First pass: Collect all bank info
            analysisResults.forEach(result => {
                const analysis = result.analysis;
                merged.banks.push({
                    name: analysis.bankName || 'Unknown Bank',
                    fileName: result.fileName,
                    accountNumber: analysis.accountNumber || 'XXXX',
                    period: analysis.statementPeriod,
                    transactions: analysis.totalTransactions || 0
                });
            });

            // Second pass: Merge transactions and detect duplicates
            analysisResults.forEach((result, bankIndex) => {
                const analysis = result.analysis;
                const bankName = analysis.bankName || `Bank ${bankIndex + 1}`;

                // Process income transactions
                (analysis.income || []).forEach(transaction => {
                    const txId = transaction.transactionId || generateTransactionId(transaction);
                    
                    if (seenTransactionIds.has(txId)) {
                        // Duplicate detected!
                        duplicateTransactions.push({
                            ...transaction,
                            bankName: bankName,
                            type: 'income'
                        });
                    } else {
                        seenTransactionIds.add(txId);
                        merged.income.push({
                            ...transaction,
                            bankName: bankName,
                            transactionId: txId
                        });
                        
                        merged.summary.totalIncome += transaction.amount;
                        if (transaction.category === 'Salary') {
                            merged.summary.salaryIncome += transaction.amount;
                        } else if (transaction.category === 'Business Income') {
                            merged.summary.businessIncome += transaction.amount;
                        } else {
                            merged.summary.otherIncome += transaction.amount;
                        }
                    }
                });

                // Process expense transactions
                (analysis.expenses || []).forEach(transaction => {
                    const txId = transaction.transactionId || generateTransactionId(transaction);
                    
                    if (seenTransactionIds.has(txId)) {
                        duplicateTransactions.push({
                            ...transaction,
                            bankName: bankName,
                            type: 'expense'
                        });
                    } else {
                        seenTransactionIds.add(txId);
                        merged.expenses.push({
                            ...transaction,
                            bankName: bankName,
                            transactionId: txId
                        });
                        
                        if (transaction.deductible) {
                            merged.summary.deductibleExpenses += transaction.amount;
                            
                            if (transaction.category.toLowerCase().includes('rent')) {
                                merged.summary.rentPaid += transaction.amount;
                            }
                            if (transaction.category.toLowerCase().includes('pension')) {
                                merged.summary.pensionContributions += transaction.amount;
                            }
                        }
                    }
                });

                // Process unclear transactions
                (analysis.unclear || []).forEach(transaction => {
                    const txId = transaction.transactionId || generateTransactionId(transaction);
                    
                    if (!seenTransactionIds.has(txId)) {
                        seenTransactionIds.add(txId);
                        merged.unclear.push({
                            ...transaction,
                            bankName: bankName,
                            transactionId: txId
                        });
                    }
                });

                // Add to totals
                merged.totalTransactions += analysis.totalTransactions || 0;
                merged.totalCredits += analysis.totalCredits || 0;
                merged.totalDebits += analysis.totalDebits || 0;
            });

            merged.duplicates = duplicateTransactions;

            // Check for inter-bank transfers and mark them
            merged.interBankTransfers = detectInterBankTransfers(merged.income, merged.expenses);

            return merged;
        }

        function generateTransactionId(transaction) {
            // Create a unique ID from date + amount + description
            const str = `${transaction.date}_${transaction.amount}_${transaction.description}`;
            // Simple hash function
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return 'tx_' + Math.abs(hash).toString(36);
        }

        function detectInterBankTransfers(incomeList, expenseList) {
            // Look for matching amounts on same/adjacent dates
            const transfers = [];
            const tolerance = 2; // Days tolerance
            
            incomeList.forEach(income => {
                expenseList.forEach(expense => {
                    // Same amount
                    if (Math.abs(income.amount - expense.amount) < 1) {
                        // Same or adjacent date
                        const incomeDate = new Date(income.date);
                        const expenseDate = new Date(expense.date);
                        const daysDiff = Math.abs((incomeDate - expenseDate) / (1000 * 60 * 60 * 24));
                        
                        if (daysDiff <= tolerance) {
                            transfers.push({
                                amount: income.amount,
                                fromBank: expense.bankName,
                                toBank: income.bankName,
                                date: income.date,
                                confidence: daysDiff === 0 ? 'high' : 'medium'
                            });
                        }
                    }
                });
            });
            
            return transfers;
        }

        function detectFinancialYear(analysisResults) {
            // Collect all transaction dates from all banks
            const allDates = [];
            const yearCounts = {};
            const monthlyBreakdown = {};
            
            analysisResults.forEach(result => {
                const analysis = result.analysis;
                
                // Collect dates from income
                (analysis.income || []).forEach(tx => {
                    if (tx.date) allDates.push(new Date(tx.date));
                });
                
                // Collect dates from expenses
                (analysis.expenses || []).forEach(tx => {
                    if (tx.date) allDates.push(new Date(tx.date));
                });
                
                // Collect dates from unclear
                (analysis.unclear || []).forEach(tx => {
                    if (tx.date) allDates.push(new Date(tx.date));
                });
            });

            if (allDates.length === 0) {
                return {
                    detectedYear: new Date().getFullYear(),
                    applicableTaxYear: '2026',
                    applicableLaw: 'New Tax Act 2025 (NTA)',
                    confidence: 'low',
                    reason: 'No transaction dates found - using current year'
                };
            }

            // Sort dates
            allDates.sort((a, b) => a - b);
            
            const earliestDate = allDates[0];
            const latestDate = allDates[allDates.length - 1];
            
            // Count transactions per year
            allDates.forEach(date => {
                const year = date.getFullYear();
                yearCounts[year] = (yearCounts[year] || 0) + 1;
                
                const monthKey = `${year}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthlyBreakdown[monthKey] = (monthlyBreakdown[monthKey] || 0) + 1;
            });

            // Find dominant year (year with most transactions)
            let dominantYear = null;
            let maxCount = 0;
            Object.keys(yearCounts).forEach(year => {
                if (yearCounts[year] > maxCount) {
                    maxCount = yearCounts[year];
                    dominantYear = parseInt(year);
                }
            });

            // Determine if it's a full financial year (Jan-Dec)
            const janKey = `${dominantYear}-01`;
            const decKey = `${dominantYear}-12`;
            const hasJanuary = monthlyBreakdown[janKey] > 0;
            const hasDecember = monthlyBreakdown[decKey] > 0;
            const isFullYear = hasJanuary && hasDecember;

            // Count how many months have transactions
            const monthsWithTransactions = Object.keys(monthlyBreakdown).filter(key => 
                key.startsWith(`${dominantYear}-`)
            ).length;

            // Determine confidence level
            let confidence = 'medium';
            if (isFullYear && monthsWithTransactions >= 11) {
                confidence = 'high';
            } else if (monthsWithTransactions >= 6) {
                confidence = 'medium';
            } else {
                confidence = 'low';
            }

            // Determine which tax law applies
            let applicableTaxYear, applicableLaw, lawDescription;
            
            if (dominantYear >= 2026) {
                applicableTaxYear = '2026';
                applicableLaw = 'New Tax Act 2025 (NTA)';
                lawDescription = 'First ‚Ç¶800,000 tax-free | Rent Relief: 20% (max ‚Ç¶500k) | Progressive rates 0%-25%';
            } else {
                applicableTaxYear = '2025';
                applicableLaw = 'Old Personal Income Tax Act (PITA)';
                lawDescription = 'CRA: 20% + higher of (1% or ‚Ç¶200k) | First ‚Ç¶300,000 @ 7% | Progressive rates 7%-24%';
            }

            // Determine filing year (the year you file the return)
            const filingYear = dominantYear + 1; // File in following year by March 31
            const filingDeadline = `March 31, ${filingYear}`;

            // Check for multi-year data
            const yearsSpanned = Object.keys(yearCounts).map(y => parseInt(y));
            const isMultiYear = yearsSpanned.length > 1;
            
            let multiYearWarning = null;
            if (isMultiYear) {
                const yearsSummary = yearsSpanned.map(y => `${y} (${yearCounts[y]} transactions)`).join(', ');
                multiYearWarning = `Transactions span multiple years: ${yearsSummary}. Using dominant year: ${dominantYear}`;
            }

            return {
                earliestTransaction: earliestDate.toISOString().split('T')[0],
                latestTransaction: latestDate.toISOString().split('T')[0],
                totalTransactions: allDates.length,
                detectedYear: dominantYear,
                isFullYear: isFullYear,
                monthsCovered: monthsWithTransactions,
                applicableTaxYear: applicableTaxYear,
                applicableLaw: applicableLaw,
                lawDescription: lawDescription,
                filingYear: filingYear,
                filingDeadline: filingDeadline,
                confidence: confidence,
                yearCounts: yearCounts,
                monthlyBreakdown: monthlyBreakdown,
                isMultiYear: isMultiYear,
                multiYearWarning: multiYearWarning,
                reason: `${maxCount} transactions (${((maxCount/allDates.length)*100).toFixed(1)}%) occurred in ${dominantYear}`
            };
        }

        function saveToTaxHistory(email, name, data) {
            const key = email.toLowerCase();
            const taxHistory = localStorage.getItem('userTaxHistory');
            const allHistory = taxHistory ? JSON.parse(taxHistory) : {};
            
            if (!allHistory[key]) {
                allHistory[key] = [];
            }
            
            allHistory[key].push({
                date: new Date().toISOString().split('T')[0],
                name: name,
                banks: data.banks.map(b => b.name),
                totalIncome: data.summary.totalIncome,
                taxYear: selectedTaxYear
            });
            
            // Keep only last 10 calculations
            if (allHistory[key].length > 10) {
                allHistory[key] = allHistory[key].slice(-10);
            }
            
            localStorage.setItem('userTaxHistory', JSON.stringify(allHistory));
        }

        function displayCompiledResults(mergedData, analysisResults) {
            document.getElementById('analysisResults').classList.remove('hidden');
            
            // Year Detection Summary
            const yearDetection = mergedData.yearDetection;
            const yearDetectionHTML = `
                <div class="year-detection">
                    <h4>üìÖ Automatic Financial Year Detection</h4>
                    <div style="margin: 10px 0;">
                        <strong>Detected Tax Year:</strong> ${yearDetection.detectedYear} (${yearDetection.isFullYear ? 'Full Jan-Dec' : `${yearDetection.monthsCovered} months`})
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>Transaction Period:</strong> ${yearDetection.earliestTransaction} to ${yearDetection.latestTransaction}
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>Applicable Tax Law:</strong> ${yearDetection.applicableLaw}
                    </div>
                    <div style="margin: 10px 0;">
                        <strong>Filing Deadline:</strong> ${yearDetection.filingDeadline}
                    </div>
                    <div style="margin: 10px 0; font-size: 13px; opacity: 0.95;">
                        <strong>Detection Confidence:</strong> ${yearDetection.confidence.toUpperCase()} 
                        (${yearDetection.reason})
                    </div>
                    
                    ${yearDetection.isMultiYear ? `
                        <div style="background: rgba(255, 193, 7, 0.2); padding: 10px; border-radius: 6px; margin-top: 10px; border-left: 3px solid #ffc107;">
                            <strong>‚ö†Ô∏è Multi-Year Data:</strong> ${yearDetection.multiYearWarning}
                        </div>
                    ` : ''}
                    
                    <div class="year-breakdown">
                        <strong>Transaction Distribution by Year:</strong>
                        ${Object.keys(yearDetection.yearCounts).sort().map(year => `
                            <div class="year-breakdown-item">
                                <span>${year}:</span>
                                <span>${yearDetection.yearCounts[year]} transactions (${((yearDetection.yearCounts[year]/yearDetection.totalTransactions)*100).toFixed(1)}%)</span>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="year-breakdown" style="margin-top: 10px;">
                        <strong>Monthly Coverage for ${yearDetection.detectedYear}:</strong>
                        <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 5px; margin-top: 8px;">
                            ${['01','02','03','04','05','06','07','08','09','10','11','12'].map(month => {
                                const monthKey = `${yearDetection.detectedYear}-${month}`;
                                const count = yearDetection.monthlyBreakdown[monthKey] || 0;
                                const monthName = new Date(2000, parseInt(month)-1, 1).toLocaleString('default', { month: 'short' });
                                return `
                                    <div style="background: ${count > 0 ? 'rgba(76, 175, 80, 0.3)' : 'rgba(255,255,255,0.1)'}; padding: 5px; border-radius: 4px; text-align: center; font-size: 11px;">
                                        <strong>${monthName}</strong><br>${count} txns
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                </div>

                <div class="law-applied">
                    <h4 style="color: #2e7d32; margin-bottom: 10px;">‚öñÔ∏è Tax Law Applied: ${yearDetection.applicableLaw}</h4>
                    <p style="margin: 0; font-size: 14px;">${yearDetection.lawDescription}</p>
                    ${yearDetection.detectedYear >= 2026 ? `
                        <div style="margin-top: 10px; padding: 10px; background: #fff9c4; border-radius: 6px; border-left: 3px solid #fbc02d;">
                            <strong>üí° New Law Benefits:</strong> You may pay LESS tax under the new law due to higher exemptions and rent relief!
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Compilation Summary
            const compilationHTML = `
                <div class="compilation-summary">
                    <h4>üè¶ Multi-Bank Compilation</h4>
                    <p><strong>Taxpayer:</strong> ${mergedData.taxpayerName || 'Not provided'}</p>
                    <p><strong>Email:</strong> ${mergedData.taxpayerEmail}</p>
                    <p><strong>Banks Analyzed:</strong> ${mergedData.numberOfBanks}</p>
                    <div style="margin-top: 10px;">
                        ${mergedData.banks.map((bank, idx) => `
                            <div style="margin: 5px 0;">
                                <span class="bank-badge bank-${bank.name.toLowerCase().replace(/\s/g, '')}">${bank.name}</span>
                                Account: ****${bank.accountNumber} | 
                                Transactions: ${bank.transactions} |
                                File: ${bank.fileName}
                            </div>
                        `).join('')}
                    </div>
                </div>

                ${mergedData.duplicates.length > 0 ? `
                    <div class="duplicate-warning">
                        <h4 style="color: #e65100; margin-bottom: 10px;">‚ö†Ô∏è Duplicates Detected & Removed</h4>
                        <p>${mergedData.duplicates.length} duplicate transaction(s) found across banks and automatically excluded to prevent double-counting:</p>
                        <table class="analysis-table" style="margin-top: 10px;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Description</th>
                                    <th>Amount</th>
                                    <th>Bank</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${mergedData.duplicates.slice(0, 5).map(dup => `
                                    <tr>
                                        <td>${dup.date}</td>
                                        <td>${dup.description}</td>
                                        <td>‚Ç¶${dup.amount.toLocaleString()}</td>
                                        <td><span class="bank-badge bank-${dup.bankName.toLowerCase().replace(/\s/g, '')}">${dup.bankName}</span></td>
                                    </tr>
                                `).join('')}
                                ${mergedData.duplicates.length > 5 ? `<tr><td colspan="4" style="text-align: center; color: #666;">... and ${mergedData.duplicates.length - 5} more</td></tr>` : ''}
                            </tbody>
                        </table>
                    </div>
                ` : `
                    <div class="merge-info">
                        <strong>‚úì Clean Merge!</strong> No duplicate transactions detected across your ${mergedData.numberOfBanks} bank account(s).
                    </div>
                `}

                ${mergedData.interBankTransfers.length > 0 ? `
                    <div class="merge-info">
                        <h4 style="color: #6a1b9a; margin-bottom: 10px;">üîÑ Inter-Bank Transfers Detected</h4>
                        <p>${mergedData.interBankTransfers.length} transfer(s) between your accounts (not counted as income):</p>
                        <ul style="margin-top: 10px; padding-left: 20px;">
                            ${mergedData.interBankTransfers.slice(0, 3).map(transfer => `
                                <li>‚Ç¶${transfer.amount.toLocaleString()} from ${transfer.fromBank} ‚Üí ${transfer.toBank} on ${transfer.date}</li>
                            `).join('')}
                            ${mergedData.interBankTransfers.length > 3 ? `<li>... and ${mergedData.interBankTransfers.length - 3} more</li>` : ''}
                        </ul>
                    </div>
                ` : ''}
            `;
            
            // Use existing display function but with merged data
            displayAnalysisResults(mergedData, compilationHTML);
        }

        function displayAnalysisResults(analysis, compilationHTML = '') {
            // Prepare prompt for Claude
            const systemPrompt = `You are an expert Nigerian tax accountant and bank statement analyzer. Your job is to:

1. Extract ALL transactions from the bank statement
2. Categorize each transaction as:
   - INCOME: Salary, business revenue, commissions, consultancy fees, rental income, etc.
   - EXPENSE: Business expenses, rent paid, utilities, etc.
   - TRANSFER: Between own accounts (not taxable)
   - UNCLEAR: Transactions that need human review

3. For INCOME transactions, identify:
   - Employment income (salary, allowances)
   - Business/professional income
   - Rental income
   - Investment income
   - Other taxable income

4. For EXPENSE transactions, identify tax-deductible items:
   - Rent paid
   - Pension contributions
   - NHF contributions
   - NHIS/Health insurance
   - Business expenses (if business account)

5. Flag UNCLEAR items that require human attention

6. Calculate total taxable income

Respond ONLY with valid JSON in this exact format:
{
  "totalTransactions": number,
  "totalCredits": number,
  "totalDebits": number,
  "income": [
    {
      "date": "YYYY-MM-DD",
      "description": "string",
      "amount": number,
      "category": "Salary|Business Income|Rental|Other",
      "confidence": "high|medium|low"
    }
  ],
  "expenses": [
    {
      "date": "YYYY-MM-DD",
      "description": "string",
      "amount": number,
      "category": "Rent|Pension|Business Expense|Other",
      "deductible": true/false,
      "confidence": "high|medium|low"
    }
  ],
  "unclear": [
    {
      "date": "YYYY-MM-DD",
      "description": "string",
      "amount": number,
      "type": "credit|debit",
      "reason": "why this needs attention"
    }
  ],
  "summary": {
    "totalIncome": number,
    "salaryIncome": number,
    "businessIncome": number,
    "otherIncome": number,
    "deductibleExpenses": number,
    "rentPaid": number,
    "pensionContributions": number
  }
}`;

            const userPrompt = fileData.type === 'csv' 
                ? `Analyze this CSV bank statement data:\n\n${fileData.data}\n\nAccount Type: ${accountType}`
                : `This is a ${fileData.type} bank statement file (base64). Account Type: ${accountType}. Please analyze it.`;

            // Call Claude API
            const response = await fetch("https://api.anthropic.com/v1/messages", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                },
                body: JSON.stringify({
                    model: "claude-sonnet-4-20250514",
                    max_tokens: 4000,
                    system: systemPrompt,
                    messages: [
                        {
                            role: "user",
                            content: fileData.type === 'pdf' || fileData.type === 'excel'
                                ? [
                                    {
                                        type: "document",
                                        source: {
                                            type: "base64",
                                            media_type: fileData.type === 'pdf' ? "application/pdf" : "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                                            data: fileData.data
                                        }
                                    },
                                    {
                                        type: "text",
                                        text: userPrompt
                                    }
                                ]
                                : userPrompt
                        }
                    ]
                })
            });

            const result = await response.json();
            
            if (!result.content || !result.content[0]) {
                throw new Error('Invalid API response');
            }

            // Extract JSON from response
            let jsonText = result.content[0].text;
            jsonText = jsonText.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
            
            return JSON.parse(jsonText);
        }

        function displayAnalysisResults(analysis, compilationHTML = '') {
            document.getElementById('analysisResults').classList.remove('hidden');
            
            // Transaction Summary
            const summaryHTML = `
                ${compilationHTML}
                
                <div class="result-row" style="background: #f5f5f5; padding: 10px; border-radius: 6px; font-weight: bold;">
                    <span class="result-label">CONSOLIDATED SUMMARY</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Total Transactions Analyzed</span>
                    <span class="result-value">${analysis.totalTransactions || 0}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Total Credits (Money In)</span>
                    <span class="result-value" style="color: #28a745;">‚Ç¶${(analysis.totalCredits || 0).toLocaleString()}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">Total Debits (Money Out)</span>
                    <span class="result-value" style="color: #dc3545;">‚Ç¶${(analysis.totalDebits || 0).toLocaleString()}</span>
                </div>
                
                <h4 style="margin-top: 20px; margin-bottom: 10px;">Income Breakdown (All Banks Combined):</h4>
                <table class="analysis-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Bank</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(analysis.income || []).map(item => `
                            <tr>
                                <td>${item.date}</td>
                                <td>${item.description}</td>
                                <td><span class="category-badge category-income">${item.category}</span></td>
                                <td><span class="bank-badge bank-${(item.bankName || 'unknown').toLowerCase().replace(/\s/g, '')}">${item.bankName || 'Unknown'}</span></td>
                                <td>‚Ç¶${item.amount.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>

                <h4 style="margin-top: 20px; margin-bottom: 10px;">Deductible Expenses (All Banks Combined):</h4>
                <table class="analysis-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Category</th>
                            <th>Bank</th>
                            <th>Amount</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${(analysis.expenses || []).filter(e => e.deductible).map(item => `
                            <tr>
                                <td>${item.date}</td>
                                <td>${item.description}</td>
                                <td><span class="category-badge category-expense">${item.category}</span></td>
                                <td><span class="bank-badge bank-${(item.bankName || 'unknown').toLowerCase().replace(/\s/g, '')}">${item.bankName || 'Unknown'}</span></td>
                                <td>‚Ç¶${item.amount.toLocaleString()}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
            document.getElementById('transactionSummary').innerHTML = summaryHTML;
            
            // Urgent Attention Items
            const urgentHTML = (analysis.unclear || []).length > 0 ? `
                <p style="margin-bottom: 15px;">These transactions need your review:</p>
                <table class="analysis-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Description</th>
                            <th>Amount</th>
                            <th>Reason</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${analysis.unclear.map(item => `
                            <tr>
                                <td>${item.date}</td>
                                <td>${item.description}</td>
                                <td>‚Ç¶${item.amount.toLocaleString()}</td>
                                <td><span class="category-badge category-unclear">${item.reason}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            ` : '<p style="color: #28a745;">‚úì No unclear transactions! All items were successfully categorized.</p>';
            document.getElementById('urgentAttention').innerHTML = urgentHTML;
            
            // Tax Calculation
            const summary = analysis.summary || {};
            const taxCalcHTML = `
                <div class="result-row">
                    <span class="result-label">Total Taxable Income</span>
                    <span class="result-value">‚Ç¶${(summary.totalIncome || 0).toLocaleString()}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">- Salary Income</span>
                    <span class="result-value">‚Ç¶${(summary.salaryIncome || 0).toLocaleString()}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">- Business/Professional Income</span>
                    <span class="result-value">‚Ç¶${(summary.businessIncome || 0).toLocaleString()}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">- Other Income</span>
                    <span class="result-value">‚Ç¶${(summary.otherIncome || 0).toLocaleString()}</span>
                </div>
                <div class="result-row" style="border-top: 2px solid #e2e8f0; margin-top: 10px; padding-top: 10px;">
                    <span class="result-label">Total Deductible Expenses</span>
                    <span class="result-value">‚Ç¶${(summary.deductibleExpenses || 0).toLocaleString()}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">- Rent Paid</span>
                    <span class="result-value">‚Ç¶${(summary.rentPaid || 0).toLocaleString()}</span>
                </div>
                <div class="result-row">
                    <span class="result-label">- Pension Contributions</span>
                    <span class="result-value">‚Ç¶${(summary.pensionContributions || 0).toLocaleString()}</span>
                </div>
                
                <p style="margin-top: 20px; padding: 15px; background: #e3f2fd; border-radius: 8px;">
                    <strong>Next Step:</strong> Click "Continue to Tax Return Filing" to complete your tax calculation with these figures automatically filled in.
                </p>
            `;
            document.getElementById('taxCalculation').innerHTML = taxCalcHTML;
        }

        function generateOptimizationSuggestions(analysis, accountType) {
            const summary = analysis.summary || {};
            const suggestions = [];
            let totalPotentialSavings = 0;

            // Calculate effective values
            const totalIncome = summary.totalIncome || 0;
            const salaryIncome = summary.salaryIncome || 0;
            const businessIncome = summary.businessIncome || 0;
            const rentPaid = summary.rentPaid || 0;
            const pensionContributions = summary.pensionContributions || 0;
            const deductibleExpenses = summary.deductibleExpenses || 0;

            // Calculate current tax (rough estimate)
            const currentTaxableIncome = totalIncome - deductibleExpenses;
            const currentTax = calculateEstimatedTax(currentTaxableIncome);

            // 1. PENSION OPTIMIZATION
            if (salaryIncome > 0) {
                const optimalPension = (salaryIncome * 0.08); // 8% minimum
                if (pensionContributions < optimalPension) {
                    const additionalPension = optimalPension - pensionContributions;
                    const taxSavings = additionalPension * 0.18; // Average tax rate
                    totalPotentialSavings += taxSavings;
                    
                    suggestions.push({
                        priority: 'high',
                        title: 'üè¶ Maximize Pension Contributions',
                        savings: taxSavings,
                        description: `You're only contributing ‚Ç¶${pensionContributions.toLocaleString()} to pension. Increase to the optimal 8% (‚Ç¶${optimalPension.toLocaleString()}) to reduce taxable income.`,
                        actions: [
                            `Increase pension contribution by ‚Ç¶${additionalPension.toLocaleString()}/year`,
                            'Contact your employer to adjust pension deductions',
                            'Ensure contribution is to an approved pension fund',
                            'This is mandatory anyway - you're just optimizing timing'
                        ],
                        impact: 'Immediate tax reduction + retirement security'
                    });
                }
            }

            // 2. RENT RELIEF OPTIMIZATION
            if (selectedTaxYear === '2026') {
                const maxRentRelief = 500000; // New law cap
                const currentRentRelief = Math.min(rentPaid * 0.20, maxRentRelief);
                
                if (rentPaid > 0 && currentRentRelief < maxRentRelief) {
                    const optimalRent = maxRentRelief / 0.20; // ‚Ç¶2.5M
                    const additionalRelief = maxRentRelief - currentRentRelief;
                    const taxSavings = additionalRelief * 0.18;
                    totalPotentialSavings += taxSavings;
                    
                    suggestions.push({
                        priority: 'medium',
                        title: 'üè† Maximize Rent Relief',
                        savings: taxSavings,
                        description: `You're claiming ‚Ç¶${currentRentRelief.toLocaleString()} rent relief but could claim up to ‚Ç¶${maxRentRelief.toLocaleString()}.`,
                        actions: [
                            'Ensure rent agreement is properly documented',
                            'Keep rent receipts from landlord',
                            'Consider renting at ‚Ç¶2.5M/year to maximize relief',
                            'Claim 20% of actual rent paid (max ‚Ç¶500k)'
                        ],
                        impact: `Up to ‚Ç¶${additionalRelief.toLocaleString()} additional deduction`
                    });
                }

                if (rentPaid === 0) {
                    suggestions.push({
                        priority: 'high',
                        title: 'üè† Missing Rent Relief',
                        savings: 90000, // Estimated
                        description: 'No rent payments detected. If you pay rent, you\'re missing a major tax deduction!',
                        actions: [
                            'Document your rent payments immediately',
                            'Get formal tenancy agreement',
                            'Request rent receipts from landlord',
                            'Claim 20% of rent paid (up to ‚Ç¶500k max)',
                            'Even if living with family, formalize payments'
                        ],
                        impact: 'Could save up to ‚Ç¶90,000 annually'
                    });
                }
            }

            // 3. NHF & NHIS OPTIMIZATION
            const hasNHF = (analysis.expenses || []).some(e => 
                e.description.toLowerCase().includes('nhf') || 
                e.description.toLowerCase().includes('housing fund')
            );
            
            const hasNHIS = (analysis.expenses || []).some(e => 
                e.description.toLowerCase().includes('nhis') || 
                e.description.toLowerCase().includes('health insurance')
            );

            if (!hasNHF && salaryIncome > 0) {
                const optimalNHF = salaryIncome * 0.025; // 2.5% of basic
                const taxSavings = optimalNHF * 0.15;
                totalPotentialSavings += taxSavings;
                
                suggestions.push({
                    priority: 'medium',
                    title: 'üè° Claim NHF Contributions',
                    savings: taxSavings,
                    description: 'No NHF (National Housing Fund) contributions detected. This is tax-deductible and helps you qualify for affordable mortgages.',
                    actions: [
                        `Contribute 2.5% of basic salary (approx ‚Ç¶${optimalNHF.toLocaleString()})`,
                        'Verify with employer if NHF is being deducted',
                        'If not deducted, request employer to start',
                        'Keep NHF payment certificates for tax filing'
                    ],
                    impact: `‚Ç¶${taxSavings.toLocaleString()} tax savings + mortgage eligibility`
                });
            }

            if (!hasNHIS && salaryIncome > 0) {
                const optimalNHIS = salaryIncome * 0.05; // 5% typical
                const taxSavings = optimalNHIS * 0.15;
                totalPotentialSavings += taxSavings;
                
                suggestions.push({
                    priority: 'medium',
                    title: 'üè• Add NHIS/Health Insurance',
                    savings: taxSavings,
                    description: 'No health insurance contributions found. This is tax-deductible and provides medical coverage.',
                    actions: [
                        'Enroll in NHIS or private HMO',
                        'Employer contributions are tax-free',
                        'Personal contributions are tax-deductible',
                        `Typical contribution: ‚Ç¶${optimalNHIS.toLocaleString()}/year`
                    ],
                    impact: `‚Ç¶${taxSavings.toLocaleString()} tax savings + health coverage`
                });
            }

            // 4. BUSINESS STRUCTURE OPTIMIZATION
            if (businessIncome > salaryIncome && businessIncome > 5000000) {
                suggestions.push({
                    priority: 'high',
                    title: 'üè¢ Consider Incorporating Your Business',
                    savings: businessIncome * 0.04, // CIT vs PIT difference
                    description: `You earned ‚Ç¶${businessIncome.toLocaleString()} from business. Incorporating might reduce your tax burden.`,
                    actions: [
                        'Register with CAC as a Limited Company',
                        'If revenue <‚Ç¶100M: Pay 0% CIT under new law',
                        'Keep business and personal finances separate',
                        'Consult tax advisor about optimal structure',
                        'Consider if annual revenue might exceed ‚Ç¶100M soon'
                    ],
                    impact: 'Potential 0% tax if under small company threshold'
                });
            }

            // 5. LIFE INSURANCE OPTIMIZATION
            const hasLifeInsurance = (analysis.expenses || []).some(e => 
                e.description.toLowerCase().includes('life insurance') ||
                e.description.toLowerCase().includes('life assurance')
            );

            if (!hasLifeInsurance && totalIncome > 3000000) {
                const recommendedPremium = Math.min(totalIncome * 0.02, 500000);
                const taxSavings = recommendedPremium * 0.18;
                totalPotentialSavings += taxSavings;
                
                suggestions.push({
                    priority: 'low',
                    title: 'üõ°Ô∏è Get Life Insurance (Tax Deductible)',
                    savings: taxSavings,
                    description: 'Life insurance premiums are fully tax-deductible and protect your family.',
                    actions: [
                        `Get life insurance policy (‚Ç¶${recommendedPremium.toLocaleString()}/year)`,
                        'Premiums for you and spouse are deductible',
                        'Choose policy from approved Nigerian insurers',
                        'Keep premium receipts for tax filing'
                    ],
                    impact: `‚Ç¶${taxSavings.toLocaleString()} tax savings + life coverage`
                });
            }

            // 6. INVESTMENT INCOME SPLITTING (for high earners)
            if (totalIncome > 10000000) {
                suggestions.push({
                    priority: 'medium',
                    title: 'üíº Income Splitting Strategy',
                    savings: totalIncome * 0.03,
                    description: 'High income attracts higher tax rates. Consider legal income splitting strategies.',
                    actions: [
                        'Employ spouse in your business at market rates',
                        'Distribute income across family members legally',
                        'Use trusts for investment income (consult lawyer)',
                        'Pay children for legitimate business work',
                        'Ensure all arrangements are commercially genuine'
                    ],
                    impact: 'Lower overall family tax burden by using lower tax brackets'
                });
            }

            // 7. TIMING OPTIMIZATION
            if (currentTaxableIncome > 800000) {
                suggestions.push({
                    priority: 'low',
                    title: 'üìÖ Strategic Timing of Income & Expenses',
                    savings: currentTax * 0.02,
                    description: 'Optimize timing of income receipt and expense payments for tax efficiency.',
                    actions: [
                        'Defer income to next year if expecting lower earnings',
                        'Accelerate deductible expenses into current year',
                        'Time large purchases to maximize capital allowances',
                        'Prepay rent in December for next year\'s relief',
                        'Consult accountant about year-end tax planning'
                    ],
                    impact: 'Smooth out tax liability across years'
                });
            }

            // 8. DOCUMENTATION IMPROVEMENT
            if ((analysis.unclear || []).length > 3) {
                suggestions.push({
                    priority: 'high',
                    title: 'üìù Improve Record Keeping',
                    savings: 0, // Prevents penalties
                    description: `${(analysis.unclear || []).length} unclear transactions detected. Poor documentation can cost you in audits.`,
                    actions: [
                        'Get receipts for ALL business expenses',
                        'Maintain separate business bank account',
                        'Use accounting software (QuickBooks, Zoho)',
                        'Digitize and backup all financial documents',
                        'Keep records for minimum 6 years',
                        'Label all transactions clearly in descriptions'
                    ],
                    impact: 'Avoid penalties, maximize deductions, audit-ready'
                });
            }

            // 9. CAPITAL ALLOWANCES (for business owners)
            if (businessIncome > 2000000 && accountType !== 'personal') {
                suggestions.push({
                    priority: 'medium',
                    title: 'üèóÔ∏è Claim Capital Allowances',
                    savings: businessIncome * 0.06,
                    description: 'Business equipment purchases qualify for capital allowances (depreciation).',
                    actions: [
                        'Document all business asset purchases',
                        'Claim Initial Allowance: 50-95% in year 1',
                        'Annual Allowance: 25-50% per year',
                        'Computers, furniture, vehicles all qualify',
                        'Keep purchase receipts and asset register',
                        'Consult accountant about optimal claiming strategy'
                    ],
                    impact: 'Significant deductions on business investments'
                });
            }

            // 10. TAX-FREE ALLOWANCES (for employees)
            if (salaryIncome > 0) {
                suggestions.push({
                    priority: 'low',
                    title: 'üí∞ Negotiate Tax-Free Allowances',
                    savings: salaryIncome * 0.03,
                    description: 'Certain allowances are tax-exempt. Restructure your compensation package.',
                    actions: [
                        'Transport allowance (within reasonable limits)',
                        'Meal vouchers/subsidies',
                        'Medical treatment abroad (employer-paid)',
                        'Training and development costs',
                        'Work-from-home allowances',
                        'Negotiate with employer to increase tax-free components'
                    ],
                    impact: 'Same take-home, lower tax bill'
                });
            }

            return {
                suggestions: suggestions,
                totalPotentialSavings: totalPotentialSavings,
                currentTax: currentTax,
                optimizedTax: currentTax - totalPotentialSavings
            };
        }

        function calculateEstimatedTax(income) {
            // Quick tax calculation for optimization purposes
            if (selectedTaxYear === '2026') {
                if (income <= 800000) return 0;
                if (income <= 3000000) return (income - 800000) * 0.15;
                if (income <= 15000000) return (2200000 * 0.15) + ((income - 3000000) * 0.18);
                return (2200000 * 0.15) + (12000000 * 0.18) + ((income - 15000000) * 0.21);
            } else {
                if (income <= 300000) return income * 0.07;
                if (income <= 600000) return (300000 * 0.07) + ((income - 300000) * 0.11);
                if (income <= 1100000) return (300000 * 0.07) + (300000 * 0.11) + ((income - 600000) * 0.15);
                return (300000 * 0.07) + (300000 * 0.11) + (500000 * 0.15) + ((income - 1100000) * 0.19);
            }
        }

        function displayOptimizationSuggestions(optimizations) {
            const { suggestions, totalPotentialSavings, currentTax, optimizedTax } = optimizations;
            
            // Sort by priority and savings
            const priorityOrder = { high: 1, medium: 2, low: 3 };
            suggestions.sort((a, b) => {
                if (priorityOrder[a.priority] !== priorityOrder[b.priority]) {
                    return priorityOrder[a.priority] - priorityOrder[b.priority];
                }
                return b.savings - a.savings;
            });

            let html = `
                <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                    <p style="margin: 0; color: #1565c0; font-size: 14px;">
                        <strong>üí° Smart Analysis:</strong> We found ${suggestions.length} ways to optimize your tax. 
                        Implementing all suggestions could save you up to <strong>‚Ç¶${Math.round(totalPotentialSavings).toLocaleString()}</strong> annually!
                    </p>
                </div>

                <div class="result-row" style="background: #f5f5f5; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                    <span class="result-label">Current Estimated Tax:</span>
                    <span class="result-value">‚Ç¶${Math.round(currentTax).toLocaleString()}</span>
                </div>
                <div class="result-row" style="background: #e8f5e9; padding: 10px; border-radius: 6px; margin-bottom: 15px;">
                    <span class="result-label">Optimized Tax (after all suggestions):</span>
                    <span class="result-value" style="color: #2e7d32;">‚Ç¶${Math.round(optimizedTax).toLocaleString()}</span>
                </div>
            `;

            suggestions.forEach((suggestion, index) => {
                html += `
                    <div class="optimization-card priority-${suggestion.priority}">
                        <h4>
                            ${index + 1}. ${suggestion.title}
                            ${suggestion.savings > 0 ? `<span class="savings">Save ‚Ç¶${Math.round(suggestion.savings).toLocaleString()}</span>` : ''}
                        </h4>
                        <p style="margin: 8px 0; color: #555;">${suggestion.description}</p>
                        <p style="margin: 5px 0; font-size: 12px; color: #666;"><strong>Impact:</strong> ${suggestion.impact}</p>
                        <details style="margin-top: 10px;">
                            <summary style="cursor: pointer; font-weight: 600; color: #6a1b9a;">Action Steps ‚ñº</summary>
                            <ul class="action-items">
                                ${suggestion.actions.map(action => `<li>${action}</li>`).join('')}
                            </ul>
                        </details>
                    </div>
                `;
            });

            html += `
                <div class="total-savings">
                    üí∞ Total Potential Annual Savings: ‚Ç¶${Math.round(totalPotentialSavings).toLocaleString()}
                    <div style="font-size: 14px; margin-top: 8px; opacity: 0.9;">
                        All suggestions are 100% legal under Nigerian tax law
                    </div>
                </div>

                <div style="background: #fff3e0; padding: 15px; border-radius: 8px; margin-top: 20px; border-left: 4px solid #ff9800;">
                    <p style="margin: 0; font-size: 13px; color: #e65100;">
                        <strong>‚öñÔ∏è Disclaimer:</strong> These are general suggestions based on your transaction data. 
                        For personalized tax advice, consult a qualified Nigerian tax professional or chartered accountant. 
                        Tax laws change frequently - verify current regulations before implementing.
                    </p>
                </div>
            `;

            document.getElementById('optimizationSuggestions').innerHTML = html;
        }

        // Proceed to filing
        document.getElementById('proceedToFiling').addEventListener('click', function() {
            if (!bankStatementData) {
                alert('No analysis data available');
                return;
            }
            
            // Switch to manual mode with pre-filled data
            document.getElementById('calculationMode').value = 'manual';
            document.getElementById('bankStatementSection').classList.add('hidden');
            document.getElementById('calculatorContent').classList.remove('hidden');
            
            // Auto-select self-employed if there's business income
            const summary = bankStatementData.summary || {};
            if (summary.businessIncome > summary.salaryIncome) {
                document.getElementById('taxType').value = 'selfemployed';
                document.getElementById('taxType').dispatchEvent(new Event('change'));
                
                // Pre-fill self-employed fields
                setTimeout(() => {
                    document.getElementById('selfGrossIncome').value = summary.totalIncome;
                    document.getElementById('selfRent').value = summary.rentPaid || 0;
                    document.getElementById('selfPension').value = summary.pensionContributions || 0;
                }, 100);
            } else {
                document.getElementById('taxType').value = 'employee';
                document.getElementById('taxType').dispatchEvent(new Event('change'));
                
                // Pre-fill employee fields
                setTimeout(() => {
                    document.getElementById('salary').value = summary.salaryIncome;
                    document.getElementById('rent').value = summary.rentPaid || 0;
                    document.getElementById('pension').value = summary.pensionContributions || 0;
                }, 100);
            }
            
            alert('‚úì Bank statement data has been transferred! Please review and complete any missing information.');
        });

        // Tax year selector
        document.getElementById('taxYear').addEventListener('change', function() {
            selectedTaxYear = this.value;
            const calculatorContent = document.getElementById('calculatorContent');
            const taxYearInfo = document.getElementById('taxYearInfo');
            
            if (selectedTaxYear === '2026') {
                taxYearInfo.innerHTML = `
                    <strong>üìÖ New Tax Act 2025 (Effective January 1, 2026)</strong><br>
                    ‚Ä¢ First ‚Ç¶800,000 tax-free<br>
                    ‚Ä¢ Rent Relief: 20% of rent, max ‚Ç¶500,000<br>
                    ‚Ä¢ No CRA (Consolidated Relief Allowance)<br>
                    ‚Ä¢ Progressive rates: 0% to 25%
                `;
                taxYearInfo.style.display = 'block';
                calculatorContent.classList.remove('hidden');
            } else if (selectedTaxYear === '2025') {
                taxYearInfo.innerHTML = `
                    <strong>üìÖ Old PITA Law (Up to December 31, 2025)</strong><br>
                    ‚Ä¢ First ‚Ç¶300,000 at 7%<br>
                    ‚Ä¢ CRA: 20% of gross income + higher of (1% of gross or ‚Ç¶200,000)<br>
                    ‚Ä¢ Progressive rates: 7% to 24%<br>
                    ‚Ä¢ Use this for filing 2025 and earlier tax returns
                `;
                taxYearInfo.style.display = 'block';
                taxYearInfo.style.background = '#fff3e0';
                taxYearInfo.style.borderLeft = '4px solid #ff9800';
                calculatorContent.classList.remove('hidden');
            } else {
                taxYearInfo.style.display = 'none';
                calculatorContent.classList.add('hidden');
            }
        });

        // Toggle sections based on tax type
        document.getElementById('taxType').addEventListener('change', function() {
            const employeeSection = document.getElementById('employeeSection');
            const selfEmployedSection = document.getElementById('selfEmployedSection');
            const companySection = document.getElementById('companySection');
            
            // Hide all sections first
            employeeSection.classList.add('hidden');
            selfEmployedSection.classList.add('hidden');
            companySection.classList.add('hidden');
            
            // Reset required fields
            document.getElementById('staffName').required = false;
            document.getElementById('selfEmployedName').required = false;
            document.getElementById('companyName').required = false;
            
            if (this.value === 'employee') {
                employeeSection.classList.remove('hidden');
                document.getElementById('staffName').required = true;
            } else if (this.value === 'selfemployed') {
                selfEmployedSection.classList.remove('hidden');
                document.getElementById('selfEmployedName').required = true;
            } else if (this.value === 'company') {
                companySection.classList.remove('hidden');
                document.getElementById('companyName').required = true;
            }
        });

        // Toggle EDI fields
        document.getElementById('hasEDI').addEventListener('change', function() {
            document.getElementById('ediGroup').classList.toggle('hidden', !this.checked);
        });

        // Toggle Free Zone fields
        document.getElementById('isFreeZone').addEventListener('change', function() {
            document.getElementById('freeZoneGroup').classList.toggle('hidden', !this.checked);
        });

        document.getElementById('taxForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const taxType = document.getElementById('taxType').value;

            if (taxType === 'employee') {
                calculateEmployeeTax();
            } else if (taxType === 'selfemployed') {
                calculateSelfEmployedTax();
            } else if (taxType === 'company') {
                calculateCompanyTax();
            }
        });

        function calculateEmployeeTax() {
            if (!selectedTaxYear) {
                alert('Please select a tax year first');
                return;
            }

            const staff = document.getElementById('staffName').value;
            const salary = parseFloat(document.getElementById('salary').value) || 0;
            const rent = parseFloat(document.getElementById('rent').value) || 0;
            const housingLoan = parseFloat(document.getElementById('housingLoan').value) || 0;
            const pension = parseFloat(document.getElementById('pension').value) || 0;
            const nhf = parseFloat(document.getElementById('nhf').value) || 0;
            const nhis = parseFloat(document.getElementById('nhis').value) || 0;
            const health = parseFloat(document.getElementById('health').value) || 0;
            const lifeInsurance = parseFloat(document.getElementById('lifeInsurance').value) || 0;
            const deductibles = parseFloat(document.getElementById('otherDeductibles').value) || 0;

            let rentRelief, cra, totalDeductions, chargeableIncome, annualTax;

            if (selectedTaxYear === '2026') {
                // New Tax Act 2025 calculation
                rentRelief = Math.min(rent * 0.20, 500000);
                totalDeductions = pension + nhf + nhis + health + lifeInsurance + 
                                 deductibles + rentRelief + housingLoan;
                chargeableIncome = salary - totalDeductions;

                // New tax bands (0%, 15%, 18%, 21%, 23%, 25%)
                if (chargeableIncome <= 0) {
                    annualTax = 0;
                } else if (chargeableIncome <= 800000) {
                    annualTax = 0;
                } else if (chargeableIncome <= 3000000) {
                    annualTax = (chargeableIncome - 800000) * 0.15;
                } else if (chargeableIncome <= 15000000) {
                    annualTax = (2200000 * 0.15) + ((chargeableIncome - 3000000) * 0.18);
                } else if (chargeableIncome <= 25000000) {
                    annualTax = (2200000 * 0.15) + (12000000 * 0.18) + ((chargeableIncome - 15000000) * 0.21);
                } else if (chargeableIncome <= 50000000) {
                    annualTax = (2200000 * 0.15) + (12000000 * 0.18) + (10000000 * 0.21) + ((chargeableIncome - 25000000) * 0.23);
                } else {
                    annualTax = (2200000 * 0.15) + (12000000 * 0.18) + (10000000 * 0.21) + (25000000 * 0.23) + ((chargeableIncome - 50000000) * 0.25);
                }
            } else {
                // Old PITA calculation
                cra = (salary * 0.20) + Math.max(salary * 0.01, 200000);
                rentRelief = 0; // No rent relief under old law
                totalDeductions = pension + nhf + nhis + health + lifeInsurance + 
                                 deductibles + housingLoan + cra;
                chargeableIncome = salary - totalDeductions;

                // Old tax bands (7%, 11%, 15%, 19%, 21%, 24%)
                if (chargeableIncome <= 0) {
                    annualTax = 0;
                } else if (chargeableIncome <= 300000) {
                    annualTax = chargeableIncome * 0.07;
                } else if (chargeableIncome <= 600000) {
                    annualTax = (300000 * 0.07) + ((chargeableIncome - 300000) * 0.11);
                } else if (chargeableIncome <= 1100000) {
                    annualTax = (300000 * 0.07) + (300000 * 0.11) + ((chargeableIncome - 600000) * 0.15);
                } else if (chargeableIncome <= 1600000) {
                    annualTax = (300000 * 0.07) + (300000 * 0.11) + (500000 * 0.15) + ((chargeableIncome - 1100000) * 0.19);
                } else if (chargeableIncome <= 3200000) {
                    annualTax = (300000 * 0.07) + (300000 * 0.11) + (500000 * 0.15) + (500000 * 0.19) + ((chargeableIncome - 1600000) * 0.21);
                } else {
                    annualTax = (300000 * 0.07) + (300000 * 0.11) + (500000 * 0.15) + (500000 * 0.19) + (1600000 * 0.21) + ((chargeableIncome - 3200000) * 0.24);
                }
            }

            const monthlyPAYE = annualTax / 12;

            calculationData = {
                taxType: 'Employee Tax (PAYE)',
                taxYear: selectedTaxYear === '2026' ? 'New Tax Act 2025 (2026+)' : 'Old PITA (2025 & Earlier)',
                staff,
                salary,
                rent,
                rentRelief: selectedTaxYear === '2026' ? rentRelief : 0,
                cra: selectedTaxYear === '2025' ? cra : 0,
                housingLoan,
                pension,
                nhf,
                nhis,
                health,
                lifeInsurance,
                deductibles,
                totalDeductions,
                chargeableIncome,
                annualTax,
                monthlyPAYE,
                effectiveTaxRate: salary > 0 ? ((annualTax / salary) * 100).toFixed(2) : 0
            };

            document.getElementById('emailModal').classList.add('active');
        }

        function calculateSelfEmployedTax() {
            if (!selectedTaxYear) {
                alert('Please select a tax year first');
                return;
            }

            const name = document.getElementById('selfEmployedName').value;
            const businessType = document.getElementById('businessType').value;
            const grossIncome = parseFloat(document.getElementById('selfGrossIncome').value) || 0;
            const businessExpenses = parseFloat(document.getElementById('selfBusinessExpenses').value) || 0;
            const rent = parseFloat(document.getElementById('selfRent').value) || 0;
            const pension = parseFloat(document.getElementById('selfPension').value) || 0;
            const nhf = parseFloat(document.getElementById('selfNHF').value) || 0;
            const nhis = parseFloat(document.getElementById('selfNHIS').value) || 0;
            const health = parseFloat(document.getElementById('selfHealthInsurance').value) || 0;
            const lifeInsurance = parseFloat(document.getElementById('selfLifeInsurance').value) || 0;

            // Calculate net business income (after business expenses)
            const netBusinessIncome = grossIncome - businessExpenses;

            // Calculate personal reliefs
            let rentRelief, cra, personalReliefs, chargeableIncome, annualTax;

            if (selectedTaxYear === '2026') {
                // New Tax Act 2025
                rentRelief = Math.min(rent * 0.20, 500000);
                personalReliefs = pension + nhf + nhis + health + lifeInsurance + rentRelief;
                chargeableIncome = netBusinessIncome - personalReliefs;

                // New tax bands
                if (chargeableIncome <= 0) {
                    annualTax = 0;
                } else if (chargeableIncome <= 800000) {
                    annualTax = 0;
                } else if (chargeableIncome <= 3000000) {
                    annualTax = (chargeableIncome - 800000) * 0.15;
                } else if (chargeableIncome <= 15000000) {
                    annualTax = (2200000 * 0.15) + ((chargeableIncome - 3000000) * 0.18);
                } else if (chargeableIncome <= 25000000) {
                    annualTax = (2200000 * 0.15) + (12000000 * 0.18) + ((chargeableIncome - 15000000) * 0.21);
                } else if (chargeableIncome <= 50000000) {
                    annualTax = (2200000 * 0.15) + (12000000 * 0.18) + (10000000 * 0.21) + ((chargeableIncome - 25000000) * 0.23);
                } else {
                    annualTax = (2200000 * 0.15) + (12000000 * 0.18) + (10000000 * 0.21) + (25000000 * 0.23) + ((chargeableIncome - 50000000) * 0.25);
                }
            } else {
                // Old PITA
                cra = (netBusinessIncome * 0.20) + Math.max(netBusinessIncome * 0.01, 200000);
                rentRelief = 0;
                personalReliefs = pension + nhf + nhis + health + lifeInsurance + cra;
                chargeableIncome = netBusinessIncome - personalReliefs;

                // Old tax bands
                if (chargeableIncome <= 0) {
                    annualTax = 0;
                } else if (chargeableIncome <= 300000) {
                    annualTax = chargeableIncome * 0.07;
                } else if (chargeableIncome <= 600000) {
                    annualTax = (300000 * 0.07) + ((chargeableIncome - 300000) * 0.11);
                } else if (chargeableIncome <= 1100000) {
                    annualTax = (300000 * 0.07) + (300000 * 0.11) + ((chargeableIncome - 600000) * 0.15);
                } else if (chargeableIncome <= 1600000) {
                    annualTax = (300000 * 0.07) + (300000 * 0.11) + (500000 * 0.15) + ((chargeableIncome - 1100000) * 0.19);
                } else if (chargeableIncome <= 3200000) {
                    annualTax = (300000 * 0.07) + (300000 * 0.11) + (500000 * 0.15) + (500000 * 0.19) + ((chargeableIncome - 1600000) * 0.21);
                } else {
                    annualTax = (300000 * 0.07) + (300000 * 0.11) + (500000 * 0.15) + (500000 * 0.19) + (1600000 * 0.21) + ((chargeableIncome - 3200000) * 0.24);
                }
            }

            // Calculate monthly equivalent (for comparison)
            const monthlyEquivalent = annualTax / 12;

            calculationData = {
                taxType: 'Self-Employed/Freelancer Tax (PIT - Self-Assessment)',
                taxYear: selectedTaxYear === '2026' ? 'New Tax Act 2025 (2026+)' : 'Old PITA (2025 & Earlier)',
                name,
                businessType,
                grossIncome,
                businessExpenses,
                netBusinessIncome,
                rent,
                rentRelief: selectedTaxYear === '2026' ? rentRelief : 0,
                cra: selectedTaxYear === '2025' ? cra : 0,
                pension,
                nhf,
                nhis,
                health,
                lifeInsurance,
                personalReliefs,
                chargeableIncome,
                annualTax,
                monthlyEquivalent,
                effectiveTaxRate: grossIncome > 0 ? ((annualTax / grossIncome) * 100).toFixed(2) : 0,
                filingDeadline: 'March 31 (following year)',
                paymentMethod: 'Self-Assessment (Form A)'
            };

            document.getElementById('emailModal').classList.add('active');
        }

        function calculateCompanyTax() {
            if (!selectedTaxYear) {
                alert('Please select a tax year first');
                return;
            }

            const companyName = document.getElementById('companyName').value;
            const grossTurnover = parseFloat(document.getElementById('grossTurnover').value) || 0;
            const totalAssets = parseFloat(document.getElementById('totalAssets').value) || 0;
            const assessableProfit = parseFloat(document.getElementById('assessableProfit').value) || 0;
            const isProfessional = document.getElementById('isProfessional').checked;
            const hasEDI = document.getElementById('hasEDI').checked;
            const ediCapex = parseFloat(document.getElementById('ediCapex').value) || 0;
            const isAgribusiness = document.getElementById('isAgribusiness').checked;
            const isFreeZone = document.getElementById('isFreeZone').checked;
            const domesticSales = parseFloat(document.getElementById('domesticSales').value) || 0;
            const capitalAllowance = parseFloat(document.getElementById('capitalAllowance').value) || 0;
            const lossCarryForward = parseFloat(document.getElementById('lossCarryForward').value) || 0;

            let isSmallCompany = false;
            let citRate = 0.30;
            let cit = 0;
            let developmentLevy = 0;
            let tertiaryEducationTax = 0;
            let ediTaxCredit = 0;
            let exemptionReason = '';
            let smallCompanyThreshold = 0;

            if (selectedTaxYear === '2026') {
                // NEW TAX ACT 2025 (Effective Jan 1, 2026)
                smallCompanyThreshold = 100000000; // ‚Ç¶100M under new law
                
                // Determine if small company (note: some sources say ‚Ç¶50M, others ‚Ç¶100M - using ‚Ç¶100M as more widely cited)
                if (!isProfessional && grossTurnover <= smallCompanyThreshold && totalAssets <= 250000000) {
                    isSmallCompany = true;
                    citRate = 0;
                    exemptionReason = `Small company exemption (turnover ‚â§‚Ç¶${(smallCompanyThreshold/1000000)}M, assets ‚â§‚Ç¶250M)`;
                }

                // Apply deductions
                let taxableProfit = assessableProfit - capitalAllowance - lossCarryForward;
                taxableProfit = Math.max(0, taxableProfit);

                // Agribusiness 5-year tax holiday
                if (isAgribusiness) {
                    citRate = 0;
                    exemptionReason = 'Agribusiness 5-year tax holiday';
                }

                // Free Zone treatment
                if (isFreeZone) {
                    if (domesticSales <= 25) {
                        citRate = 0;
                        exemptionReason = 'Free Zone 100% exemption (domestic sales ‚â§25%)';
                    } else {
                        const taxablePortion = domesticSales / 100;
                        taxableProfit = taxableProfit * taxablePortion;
                        exemptionReason = `Free Zone partial exemption (${domesticSales}% domestic sales taxable)`;
                    }
                }

                // Calculate CIT (30% under new law for large companies)
                cit = taxableProfit * citRate;

                // EDI Tax Credit (5% per annum for 5 years)
                if (hasEDI && ediCapex > 0) {
                    ediTaxCredit = ediCapex * 0.05;
                    cit = Math.max(0, cit - ediTaxCredit);
                }

                // Development Levy (4% on assessable profit - NEW, replaces multiple old taxes)
                // Only for non-small companies
                if (!isSmallCompany && !isAgribusiness) {
                    developmentLevy = assessableProfit * 0.04;
                }

                // No Tertiary Education Tax under new law (consolidated into Development Levy)
                tertiaryEducationTax = 0;

            } else {
                // OLD PITA/CITA LAW (Up to Dec 31, 2025)
                smallCompanyThreshold = 25000000; // ‚Ç¶25M under old law
                
                // Small company definition under old law
                if (!isProfessional && grossTurnover <= smallCompanyThreshold) {
                    isSmallCompany = true;
                    citRate = 0;
                    exemptionReason = `Small company exemption (turnover ‚â§‚Ç¶${(smallCompanyThreshold/1000000)}M)`;
                } else if (grossTurnover <= 100000000) {
                    // Medium company: 20% CIT under old law
                    citRate = 0.20;
                } else {
                    // Large company: 30% CIT under old law
                    citRate = 0.30;
                }

                // Apply deductions
                let taxableProfit = assessableProfit - capitalAllowance - lossCarryForward;
                taxableProfit = Math.max(0, taxableProfit);

                // Agribusiness tax holiday (existed under old law too)
                if (isAgribusiness) {
                    citRate = 0;
                    exemptionReason = 'Agribusiness tax holiday';
                }

                // Free Zone treatment (same under old law)
                if (isFreeZone) {
                    if (domesticSales <= 25) {
                        citRate = 0;
                        exemptionReason = 'Free Zone 100% exemption (domestic sales ‚â§25%)';
                    } else {
                        const taxablePortion = domesticSales / 100;
                        taxableProfit = taxableProfit * taxablePortion;
                        exemptionReason = `Free Zone partial exemption (${domesticSales}% domestic sales taxable)`;
                    }
                }

                // Calculate CIT
                cit = taxableProfit * citRate;

                // EDI existed under old law too
                if (hasEDI && ediCapex > 0) {
                    ediTaxCredit = ediCapex * 0.05;
                    cit = Math.max(0, cit - ediTaxCredit);
                }

                // Tertiary Education Tax (3% under old law - SEPARATE from CIT)
                // Only for non-small companies
                if (!isSmallCompany && !isAgribusiness) {
                    tertiaryEducationTax = assessableProfit * 0.03;
                }

                // No Development Levy under old law (didn't exist yet)
                developmentLevy = 0;
            }

            const totalTax = cit + developmentLevy + tertiaryEducationTax;
            const effectiveTaxRate = assessableProfit > 0 ? ((totalTax / assessableProfit) * 100).toFixed(2) : 0;

            calculationData = {
                taxType: 'Company Tax (CIT)',
                taxYear: selectedTaxYear === '2026' ? 'New Tax Act 2025 (2026+)' : 'Old CITA (2025 & Earlier)',
                companyName,
                grossTurnover,
                totalAssets,
                assessableProfit,
                isSmallCompany,
                smallCompanyThreshold,
                isProfessional,
                capitalAllowance,
                lossCarryForward,
                taxableProfit: assessableProfit - capitalAllowance - lossCarryForward,
                citRate: (citRate * 100).toFixed(0) + '%',
                cit,
                ediTaxCredit,
                developmentLevy,
                tertiaryEducationTax,
                totalTax,
                effectiveTaxRate,
                exemptionReason,
                isAgribusiness,
                isFreeZone,
                domesticSales: isFreeZone ? domesticSales : null
            };

            document.getElementById('emailModal').classList.add('active');
        }

        document.getElementById('cancelBtn').addEventListener('click', function() {
            document.getElementById('emailModal').classList.remove('active');
            document.getElementById('userEmail').value = '';
            document.getElementById('limitExceeded').style.display = 'none';
            document.getElementById('usageInfo').style.display = 'none';
        });

        // Check usage when email is entered
        document.getElementById('userEmail').addEventListener('blur', function() {
            const email = this.value.trim();
            if (email && email.includes('@')) {
                const usageCheck = checkUsageLimit(email);
                const usageInfo = document.getElementById('usageInfo');
                const remainingCalcs = document.getElementById('remainingCalcs');
                const bonusInfo = document.getElementById('bonusInfo');
                const bonusCount = document.getElementById('bonusCount');
                
                if (usageCheck.allowed) {
                    usageInfo.style.display = 'block';
                    remainingCalcs.textContent = usageCheck.remaining;
                    
                    if (usageCheck.bonusCalcs > 0) {
                        bonusInfo.style.display = 'inline';
                        bonusCount.textContent = usageCheck.bonusCalcs;
                    } else {
                        bonusInfo.style.display = 'none';
                    }
                    
                    document.getElementById('limitExceeded').style.display = 'none';
                } else {
                    usageInfo.style.display = 'none';
                    document.getElementById('limitExceeded').style.display = 'block';
                    document.getElementById('submitBtn').disabled = true;
                }
            }
        });

        // Re-enable submit button when email changes
        document.getElementById('userEmail').addEventListener('input', function() {
            document.getElementById('submitBtn').disabled = false;
            document.getElementById('limitExceeded').style.display = 'none';
            document.getElementById('usageInfo').style.display = 'none';
        });

        document.getElementById('submitBtn').addEventListener('click', async function() {
            const userEmail = document.getElementById('userEmail').value.trim();
            
            if (!userEmail || !userEmail.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }

            // Check usage limit
            const usageCheck = checkUsageLimit(userEmail);
            
            if (!usageCheck.allowed) {
                document.getElementById('limitExceeded').style.display = 'block';
                document.getElementById('submitBtn').disabled = true;
                return;
            }

            // Track referral if came from referral link
            const refCode = sessionStorage.getItem('referralCode');
            if (refCode) {
                trackReferral(refCode, userEmail);
                sessionStorage.removeItem('referralCode');
            }

            const submitBtn = this;
            submitBtn.disabled = true;
            submitBtn.textContent = 'Sending...';

            // Prepare calculation details text
            let calculationDetails = '';
            
            if (calculationData.taxType && calculationData.taxType.includes('Employee')) {
                calculationDetails = `
================================================================================
PERSONAL INCOME TAX RETURN (FORM A FORMAT)
FEDERAL REPUBLIC OF NIGERIA
================================================================================
Tax Year/Law: ${calculationData.taxYear}
Filing Deadline: March 31, ${new Date().getFullYear() + 1}
State IRS: [Your State Internal Revenue Service]

SECTION A: TAXPAYER INFORMATION
--------------------------------------------------------------------------------
Full Name: ${calculationData.staff}
Tax Identification Number (TIN): [Enter your TIN]
Address: [Enter your residential address]
Phone Number: [Enter phone number]
Email Address: [Email address]

SECTION B: EMPLOYMENT INCOME (PAYE)
--------------------------------------------------------------------------------
Employer Name: [Enter employer name]
Employer TIN: [Enter employer TIN]
Annual Gross Salary (Line 10): ‚Ç¶${calculationData.salary.toLocaleString()}

SECTION C: ALLOWABLE RELIEFS AND DEDUCTIONS
--------------------------------------------------------------------------------
${calculationData.cra > 0 ? `Consolidated Relief Allowance (CRA): ‚Ç¶${calculationData.cra.toLocaleString()}` : ''}
${calculationData.rentRelief > 0 ? `Rent Relief (20% of rent, max ‚Ç¶500k): ‚Ç¶${calculationData.rentRelief.toLocaleString()}` : ''}
Pension Contributions (Employee): ‚Ç¶${calculationData.pension.toLocaleString()}
National Housing Fund (NHF): ‚Ç¶${calculationData.nhf.toLocaleString()}
NHIS Contributions: ‚Ç¶${calculationData.nhis.toLocaleString()}
Life Insurance Premium: ‚Ç¶${calculationData.lifeInsurance.toLocaleString()}
Health Insurance Premium: ‚Ç¶${calculationData.health.toLocaleString()}
Interest on Housing Loan: ‚Ç¶${calculationData.housingLoan.toLocaleString()}
Other Allowable Deductions: ‚Ç¶${calculationData.deductibles.toLocaleString()}
--------------------------------------------------------------------------------
Total Reliefs & Deductions (Line 40): ‚Ç¶${calculationData.totalDeductions.toLocaleString()}

SECTION D: TAX COMPUTATION
--------------------------------------------------------------------------------
Gross Income (Line 10): ‚Ç¶${calculationData.salary.toLocaleString()}
Less: Total Reliefs (Line 40): (‚Ç¶${calculationData.totalDeductions.toLocaleString()})
Chargeable Income (Line 50): ‚Ç¶${calculationData.chargeableIncome.toLocaleString()}

TAX CALCULATION (Using ${calculationData.taxYear.includes('New') ? 'NTA 2025' : 'PITA'} Tax Bands):
${calculationData.taxYear.includes('New') ? `
  First ‚Ç¶800,000 @ 0%:        ‚Ç¶0
  Next ‚Ç¶2,200,000 @ 15%:      ‚Ç¶${Math.min(calculationData.chargeableIncome - 800000, 2200000) > 0 ? (Math.min(calculationData.chargeableIncome - 800000, 2200000) * 0.15).toLocaleString() : '0'}
  Next ‚Ç¶12,000,000 @ 18%:     ‚Ç¶${Math.min(Math.max(calculationData.chargeableIncome - 3000000, 0), 12000000) > 0 ? (Math.min(Math.max(calculationData.chargeableIncome - 3000000, 0), 12000000) * 0.18).toLocaleString() : '0'}
  Next ‚Ç¶10,000,000 @ 21%:     ‚Ç¶${Math.max(calculationData.chargeableIncome - 15000000, 0) > 0 && calculationData.chargeableIncome <= 25000000 ? ((calculationData.chargeableIncome - 15000000) * 0.21).toLocaleString() : '0'}
  Next ‚Ç¶25,000,000 @ 23%:     ‚Ç¶${Math.max(calculationData.chargeableIncome - 25000000, 0) > 0 && calculationData.chargeableIncome <= 50000000 ? ((calculationData.chargeableIncome - 25000000) * 0.23).toLocaleString() : '0'}
  Above ‚Ç¶50,000,000 @ 25%:    ‚Ç¶${Math.max(calculationData.chargeableIncome - 50000000, 0) > 0 ? ((calculationData.chargeableIncome - 50000000) * 0.25).toLocaleString() : '0'}` : `
  First ‚Ç¶300,000 @ 7%:        ‚Ç¶${Math.min(calculationData.chargeableIncome, 300000) > 0 ? (Math.min(calculationData.chargeableIncome, 300000) * 0.07).toLocaleString() : '0'}
  Next ‚Ç¶300,000 @ 11%:        ‚Ç¶${Math.min(Math.max(calculationData.chargeableIncome - 300000, 0), 300000) > 0 ? (Math.min(Math.max(calculationData.chargeableIncome - 300000, 0), 300000) * 0.11).toLocaleString() : '0'}
  Next ‚Ç¶500,000 @ 15%:        ‚Ç¶${Math.min(Math.max(calculationData.chargeableIncome - 600000, 0), 500000) > 0 ? (Math.min(Math.max(calculationData.chargeableIncome - 600000, 0), 500000) * 0.15).toLocaleString() : '0'}
  Next ‚Ç¶500,000 @ 19%:        ‚Ç¶${Math.min(Math.max(calculationData.chargeableIncome - 1100000, 0), 500000) > 0 ? (Math.min(Math.max(calculationData.chargeableIncome - 1100000, 0), 500000) * 0.19).toLocaleString() : '0'}
  Next ‚Ç¶1,600,000 @ 21%:      ‚Ç¶${Math.min(Math.max(calculationData.chargeableIncome - 1600000, 0), 1600000) > 0 ? (Math.min(Math.max(calculationData.chargeableIncome - 1600000, 0), 1600000) * 0.21).toLocaleString() : '0'}
  Above ‚Ç¶3,200,000 @ 24%:     ‚Ç¶${Math.max(calculationData.chargeableIncome - 3200000, 0) > 0 ? ((calculationData.chargeableIncome - 3200000) * 0.24).toLocaleString() : '0'}`}
--------------------------------------------------------------------------------
Total Tax Payable (Line 60): ‚Ç¶${calculationData.annualTax.toLocaleString()}

MONTHLY BREAKDOWN (For Employer's PAYE Deduction):
Monthly PAYE to be Deducted: ‚Ç¶${calculationData.monthlyPAYE.toLocaleString()}

Effective Tax Rate: ${calculationData.effectiveTaxRate}%

SECTION E: DECLARATION
--------------------------------------------------------------------------------
I declare that the information provided in this return is true, correct and complete.

Name: ${calculationData.staff}
Signature: _____________________
Date: _____________________

FILING INSTRUCTIONS:
--------------------------------------------------------------------------------
1. Complete this form and submit to your State Internal Revenue Service
2. Attach supporting documents: payslips, bank statements, pension certificates
3. File online via your State IRS e-filing portal or TaxPro Max
4. Pay any outstanding tax via approved payment channels
5. Obtain Tax Clearance Certificate (TCC) after filing
6. Keep copies for your records (minimum 6 years)

NOTE: This is a computer-generated tax calculation. Verify all figures before filing.
================================================================================
                `;
            } else if (calculationData.taxType && calculationData.taxType.includes('Self-Employed')) {
                calculationDetails = `
================================================================================
PERSONAL INCOME TAX RETURN (FORM A FORMAT) - SELF-EMPLOYED
FEDERAL REPUBLIC OF NIGERIA
================================================================================
Tax Year/Law: ${calculationData.taxYear}
Filing Deadline: March 31, ${new Date().getFullYear() + 1}
State IRS: [Your State Internal Revenue Service]

SECTION A: TAXPAYER INFORMATION
--------------------------------------------------------------------------------
Full Name/Business Name: ${calculationData.name}
Tax Identification Number (TIN): [Enter your TIN]
Business Type: ${calculationData.businessType}
Business Address: [Enter business address]
Phone Number: [Enter phone number]
Email Address: [Email address]

SECTION B: BUSINESS/PROFESSIONAL INCOME
--------------------------------------------------------------------------------
Total Gross Income (Line 10): ‚Ç¶${calculationData.grossIncome.toLocaleString()}
  (Commission, fees, sales, or other business income)

Business Expenses (Line 20):
  Total Allowable Expenses: (‚Ç¶${calculationData.businessExpenses.toLocaleString()})
  (Rent, transport, materials, salaries, utilities, etc.)

Net Business Income (Line 30): ‚Ç¶${calculationData.netBusinessIncome.toLocaleString()}

SECTION C: ALLOWABLE RELIEFS AND DEDUCTIONS
--------------------------------------------------------------------------------
${calculationData.cra > 0 ? `Consolidated Relief Allowance (CRA): ‚Ç¶${calculationData.cra.toLocaleString()}` : ''}
${calculationData.rentRelief > 0 ? `Rent Relief (20% of rent, max ‚Ç¶500k): ‚Ç¶${calculationData.rentRelief.toLocaleString()}` : ''}
Voluntary Pension Contributions: ‚Ç¶${calculationData.pension.toLocaleString()}
National Housing Fund (NHF): ‚Ç¶${calculationData.nhf.toLocaleString()}
NHIS Contributions: ‚Ç¶${calculationData.nhis.toLocaleString()}
Life Insurance Premium: ‚Ç¶${calculationData.lifeInsurance.toLocaleString()}
Health Insurance Premium: ‚Ç¶${calculationData.health.toLocaleString()}
--------------------------------------------------------------------------------
Total Personal Reliefs (Line 40): ‚Ç¶${calculationData.personalReliefs.toLocaleString()}

SECTION D: TAX COMPUTATION
--------------------------------------------------------------------------------
Net Business Income (Line 30): ‚Ç¶${calculationData.netBusinessIncome.toLocaleString()}
Less: Personal Reliefs (Line 40): (‚Ç¶${calculationData.personalReliefs.toLocaleString()})
Chargeable Income (Line 50): ‚Ç¶${calculationData.chargeableIncome.toLocaleString()}

TAX CALCULATION (Using ${calculationData.taxYear.includes('New') ? 'NTA 2025' : 'PITA'} Tax Bands):
[Same progressive bands as above]
--------------------------------------------------------------------------------
Total Tax Payable (Line 60): ‚Ç¶${calculationData.annualTax.toLocaleString()}
Monthly Equivalent (for planning): ‚Ç¶${calculationData.monthlyEquivalent.toLocaleString()}

Effective Tax Rate: ${calculationData.effectiveTaxRate}%

SECTION E: PAYMENT SCHEDULE
--------------------------------------------------------------------------------
Payment Method: Self-Assessment (Direct Payment)
Tax Due: ‚Ç¶${calculationData.annualTax.toLocaleString()}
Payment Options: Lump sum or quarterly installments (if approved)

SECTION F: DECLARATION
--------------------------------------------------------------------------------
I declare that the information provided in this return is true, correct and complete.
I have attached all supporting documents including business records, receipts, and bank statements.

Name: ${calculationData.name}
Signature: _____________________
Date: _____________________

FILING INSTRUCTIONS:
--------------------------------------------------------------------------------
1. Complete this Form A and submit to your State IRS
2. Attach: Business records, bank statements, receipts, rent agreement
3. File online via TaxPro Max or State IRS portal
4. Pay tax due via approved bank or online payment
5. Obtain Tax Clearance Certificate (TCC) after payment
6. Keep records for minimum 6 years

IMPORTANT REMINDERS:
‚Ä¢ You must file even if your tax is ‚Ç¶0
‚Ä¢ Late filing attracts 10% penalty per annum
‚Ä¢ Installment payment requires FIRS/SIRS approval
‚Ä¢ Obtain Tax Identification Number (TIN) before filing

NOTE: This is a computer-generated tax calculation. Verify all figures before filing.
================================================================================
                `;
            } else if (calculationData.taxType && calculationData.taxType.includes('Company')) {
                calculationDetails = `
================================================================================
COMPANIES INCOME TAX RETURN (FORM 001 FORMAT)
FEDERAL INLAND REVENUE SERVICE (FIRS)
================================================================================
Tax Year/Law: ${calculationData.taxYear}
Filing Deadline: 6 months after accounting year-end
Payment Deadline: Within 2 months of self-assessment

SECTION A: COMPANY PARTICULARS
--------------------------------------------------------------------------------
Company Name: ${calculationData.companyName}
Tax Identification Number (TIN): [Enter company TIN]
RC Number: [Enter CAC RC Number]
Address: [Enter registered office address]
Industry: [Enter industry/business type]
Accounting Year End: [Enter date]

SECTION B: FINANCIAL SUMMARY
--------------------------------------------------------------------------------
Line 10: Gross Turnover: ‚Ç¶${calculationData.grossTurnover.toLocaleString()}
Line 80: Total Fixed Assets: ‚Ç¶${calculationData.totalAssets.toLocaleString()}
Line 90: Total Current Assets: [Enter amount]
Line 100: Total Assets: ‚Ç¶${calculationData.totalAssets.toLocaleString()}

Company Classification: ${calculationData.isSmallCompany ? 'SMALL COMPANY' : 'LARGE COMPANY'}
${calculationData.exemptionReason ? `Classification Reason: ${calculationData.exemptionReason}` : ''}

SECTION C: PROFIT AND LOSS
--------------------------------------------------------------------------------
Line 50: Operating Income: [Enter total revenue]
Line 60: Operating Expenses: [Enter total expenses]
Line 70: Profit Before Tax: ‚Ç¶${calculationData.assessableProfit.toLocaleString()}

SECTION D: TAX ADJUSTMENTS
--------------------------------------------------------------------------------
Line 200: Assessable Profit: ‚Ç¶${calculationData.assessableProfit.toLocaleString()}
Line 210: Add: Balancing Charge: ‚Ç¶0
Line 220: Less: Balancing Allowance: ‚Ç¶0

SECTION E: CAPITAL ALLOWANCES
--------------------------------------------------------------------------------
Line 250: Capital Allowances Claimed:
  - Initial Allowance: [Enter amount]
  - Annual Allowance: ‚Ç¶${calculationData.capitalAllowance.toLocaleString()}
  - Investment Allowance: [Enter if applicable]
  - Rural Investment Allowance: [Enter if applicable]
  
Total Capital Allowances (Line 250): ‚Ç¶${calculationData.capitalAllowance.toLocaleString()}

SECTION F: CHARGEABLE PROFIT
--------------------------------------------------------------------------------
Line 240: Chargeable Profit Before Capital Allowance: ‚Ç¶${calculationData.assessableProfit.toLocaleString()}
Line 250: Less: Capital Allowances: (‚Ç¶${calculationData.capitalAllowance.toLocaleString()})
          Less: Loss Carried Forward: (‚Ç¶${calculationData.lossCarryForward.toLocaleString()})
Line 260: Total Profit (Taxable Profit): ‚Ç¶${calculationData.taxableProfit.toLocaleString()}

SECTION G: TAX COMPUTATION
--------------------------------------------------------------------------------
Line 260: Taxable Profit: ‚Ç¶${calculationData.taxableProfit.toLocaleString()}
Line 275: CIT Rate Applied: ${calculationData.citRate}
Line 275: Company Income Tax @ ${calculationData.citRate}: ‚Ç¶${calculationData.cit.toLocaleString()}

${calculationData.ediTaxCredit > 0 ? `
EDI Tax Credit (5% of qualifying capex):
  Qualifying Capital Expenditure: [Enter amount]
  Tax Credit (5% per annum): (‚Ç¶${calculationData.ediTaxCredit.toLocaleString()})
` : ''}

Line 280: Minimum Tax (if applicable): ‚Ç¶0
  [Minimum tax = 0.5% of gross turnover, if higher than regular tax]

Line 300: Total CIT Payable: ‚Ç¶${calculationData.cit.toLocaleString()}

SECTION H: OTHER TAXES AND LEVIES
--------------------------------------------------------------------------------
${calculationData.developmentLevy > 0 ? `
Development Levy (New Law - 4% of assessable profit):
  Assessable Profit: ‚Ç¶${calculationData.assessableProfit.toLocaleString()}
  Development Levy @ 4%: ‚Ç¶${calculationData.developmentLevy.toLocaleString()}
  (Replaces: TET, IT Levy, NASENI, Police Trust Fund)
` : ''}

${calculationData.tertiaryEducationTax > 0 ? `
Tertiary Education Tax (Old Law - 3% of assessable profit):
  Assessable Profit: ‚Ç¶${calculationData.assessableProfit.toLocaleString()}
  TET @ 3%: ‚Ç¶${calculationData.tertiaryEducationTax.toLocaleString()}
` : ''}

SECTION I: TOTAL TAX LIABILITY
--------------------------------------------------------------------------------
Company Income Tax (CIT): ‚Ç¶${calculationData.cit.toLocaleString()}
${calculationData.developmentLevy > 0 ? `Development Levy: ‚Ç¶${calculationData.developmentLevy.toLocaleString()}` : ''}
${calculationData.tertiaryEducationTax > 0 ? `Tertiary Education Tax: ‚Ç¶${calculationData.tertiaryEducationTax.toLocaleString()}` : ''}
--------------------------------------------------------------------------------
TOTAL TAX PAYABLE: ‚Ç¶${calculationData.totalTax.toLocaleString()}

Effective Tax Rate: ${calculationData.effectiveTaxRate}%

SECTION J: TAX CREDITS
--------------------------------------------------------------------------------
Line 340: Unrelieved WHT/Overpayment b/f: [Enter amount]
Line 345: Current Year WHT Credits: [Enter amount]
Line 370: Total WHT Credits Claimable: [Enter amount]
Line 380: WHT Credits Applied: [Enter amount]

Line 400: NET TAX PAYABLE: ‚Ç¶${calculationData.totalTax.toLocaleString()}

SECTION K: PAYMENT DECLARATION
--------------------------------------------------------------------------------
Payment Mode: ‚ñ° Bank Draft  ‚ñ° Online Transfer  ‚ñ° Other
Bank: [Enter bank name]
Teller Number: [Enter teller number]
Payment Date: [Enter date]
Amount Paid: ‚Ç¶${calculationData.totalTax.toLocaleString()}

SECTION L: DECLARATION
--------------------------------------------------------------------------------
We declare that the information in this return and attached documents is true,
correct and complete to the best of our knowledge.

Director 1:
Name: _____________________
Signature: _____________________
Date: _____________________

Director 2:
Name: _____________________
Signature: _____________________
Date: _____________________

Company Secretary:
Name: _____________________
Signature: _____________________
Date: _____________________

REQUIRED ATTACHMENTS:
--------------------------------------------------------------------------------
‚úì Audited Financial Statements (IFRS compliant)
‚úì Tax Computation Schedules
‚úì Capital Allowance Schedule
‚úì Withholding Tax Credit Schedule
‚úì Evidence of Payment
‚úì Transfer Pricing Documentation (if applicable)

FILING INSTRUCTIONS:
--------------------------------------------------------------------------------
1. File via FIRS TaxPro-Max portal: www.firs.gov.ng
2. Upload all required documents in PDF format
3. Pay via approved payment channels
4. Obtain Assessment Notice and Receipt
5. Keep copies for minimum 6 years
6. Apply for Tax Clearance Certificate if needed

${calculationData.taxYear.includes('New') ? `
NEW TAX ACT 2025 NOTES:
‚Ä¢ Small companies (‚â§‚Ç¶100M turnover, ‚â§‚Ç¶250M assets): 0% CIT
‚Ä¢ Professional services excluded from small company exemption
‚Ä¢ Development Levy (4%) replaces TET, IT Levy, NASENI, Police Trust Fund
‚Ä¢ CGT rate increased to 30% (harmonized with CIT)
` : `
OLD CITA NOTES:
‚Ä¢ Small companies (‚â§‚Ç¶25M turnover): 0% CIT
‚Ä¢ Medium companies (‚Ç¶25M-‚Ç¶100M): 20% CIT
‚Ä¢ Large companies (>‚Ç¶100M): 30% CIT
‚Ä¢ Tertiary Education Tax: 3% of assessable profit (separate)
`}

NOTE: This is a computer-generated tax calculation. Have it reviewed by a 
chartered accountant before filing with FIRS.
================================================================================
                `;
            }

            // Email parameters for your copy (to kwadonzeh@gmail.com)
            const adminEmailParams = {
                to_name: 'Admin',
                to_email: 'kwadonzeh@gmail.com',
                from_email: userEmail,
                user_email: userEmail,
                tax_type: calculationData.taxType,
                calculation_details: calculationDetails,
                timestamp: new Date().toLocaleString('en-NG', { timeZone: 'Africa/Lagos' }),
                reply_to: userEmail
            };

            // Email parameters for user's copy
            const userEmailParams = {
                to_name: 'User',
                to_email: userEmail,
                from_email: 'noreply@taxcalculator.com',
                user_email: userEmail,
                tax_type: calculationData.taxType,
                calculation_details: calculationDetails,
                timestamp: new Date().toLocaleString('en-NG', { timeZone: 'Africa/Lagos' }),
                reply_to: 'kwadonzeh@gmail.com'
            };

            try {
                // Send email to admin (you) first
                console.log('Sending email to admin:', adminEmailParams.to_email);
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, adminEmailParams);
                console.log('Admin email sent successfully!');
                
                // Send email to user
                console.log('Sending email to user:', userEmailParams.to_email);
                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, userEmailParams);
                console.log('User email sent successfully!');

                // Log to console for debugging
                console.log('===== TAX CALCULATION SUMMARY =====');
                console.log(`Tax Type: ${calculationData.taxType}`);
                console.log(`User Email: ${userEmail}`);
                console.log(calculationDetails);
                console.log('=====================================');
                console.log('Emails sent successfully!');

                // Increment usage count AFTER successful email send
                const newCount = incrementEmailUsage(userEmail);
                const remaining = MAX_FREE_CALCULATIONS - newCount;
                
                console.log(`Usage: ${newCount}/${MAX_FREE_CALCULATIONS} calculations used`);
                console.log(`Remaining: ${remaining} free calculations`);

                // Calculate savings to display
                let savingsAmount = 0;
                let savingsDescription = '';
                
                if (calculationData.taxType && calculationData.taxType.includes('Employee')) {
                    // Estimate what they would pay without deductions
                    const withoutDeductions = calculationData.salary * 0.18; // Rough average
                    savingsAmount = Math.max(0, withoutDeductions - calculationData.annualTax);
                    savingsDescription = 'Saved through pension, rent relief, and other deductions';
                } else if (calculationData.taxType && calculationData.taxType.includes('Self-Employed')) {
                    const withoutDeductions = calculationData.grossIncome * 0.15;
                    savingsAmount = Math.max(0, withoutDeductions - calculationData.annualTax);
                    savingsDescription = 'Saved through business expenses and personal reliefs';
                } else if (calculationData.taxType && calculationData.taxType.includes('Company')) {
                    if (calculationData.isSmallCompany) {
                        savingsAmount = calculationData.assessableProfit * 0.30;
                        savingsDescription = 'Saved through small company exemption';
                    } else {
                        const withoutIncentives = calculationData.assessableProfit * 0.30;
                        savingsAmount = Math.max(0, withoutIncentives - calculationData.totalTax);
                        savingsDescription = 'Saved through incentives and allowances';
                    }
                }

                document.getElementById('emailModal').classList.remove('active');
                document.getElementById('userEmail').value = '';
                
                // Show results card
                showResultsCard(userEmail, savingsAmount, savingsDescription);
                
                // Show success message with usage info
                const successMsg = document.getElementById('successMessage');
                const bonusInfo = usageCheck.bonusCalcs > 0 ? ` (including ${usageCheck.bonusCalcs} bonus)` : '';
                if (remaining > 0) {
                    successMsg.innerHTML = `‚úì Email sent successfully!<br><small>You have ${remaining} free calculation(s) remaining${bonusInfo}.</small>`;
                } else {
                    successMsg.innerHTML = `‚úì Email sent successfully!<br><small>Share with friends to get more free calculations!</small>`;
                }
                
                successMsg.classList.add('active');
                document.getElementById('taxForm').reset();
                document.getElementById('employeeSection').classList.add('hidden');
                document.getElementById('selfEmployedSection').classList.add('hidden');
                document.getElementById('companySection').classList.add('hidden');
                document.getElementById('limitExceeded').style.display = 'none';
                document.getElementById('usageInfo').style.display = 'none';
                
                setTimeout(() => {
                    successMsg.classList.remove('active');
                }, 7000);

            } catch (error) {
                console.error('Email sending failed:', error);
                alert('Failed to send email. Please check your EmailJS configuration and try again.\n\nError: ' + error.text);
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Submit';
            }
        });

        document.getElementById('emailModal').addEventListener('click', function(e) {
            if (e.target === this) {
                this.classList.remove('active');
                document.getElementById('userEmail').value = '';
            }
        });
    </script>
</body>
</html>